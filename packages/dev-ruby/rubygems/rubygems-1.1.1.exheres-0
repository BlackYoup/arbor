# Copyright 2007 Richard Brown
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'rubygems-1.0.1.ebuild' from Gentoo, which is:
#     Copyright 1999-2007 Gentoo Foundation

require multilib versionator

SUMMARY="Centralised Ruby extension management"
HOMEPAGE="http://rubyforge.org/projects/rubygems/"
LICENSE="|| ( Ruby GPL-2 )"

PLATFORMS="~amd64 ~x86"
SLOT="0"
MYOPTIONS="doc"

SRC_URI="mirror://rubyforge/${PN}/${P}.tgz"

DEPENDENCIES="
    build+run:
        ( dev-lang/ruby )
"

DEFAULT_SRC_PREPARE_PATCHES=(
    -p0 "${FILESDIR}/${PN}-1.1.1-setup.patch"
)
 
src_install() {

    ver=$(ruby -r rbconfig -e 'print Config::CONFIG["ruby_version"]')
    ver_stripped=$(delete_version_separator 1 ${ver})
    unset RUBYOPT
    
    export GEM_HOME="${D}/usr/$(get_libdir)/ruby/gems/${ver}/"
    keepdir /usr/$(get_libdir)/ruby/gems/${ver}/{doc,gems,cache,specifications}

    myconf=""
    if ! option doc; then
        myconf="${myconf} --no-rdoc --no-ri"
    fi

    ruby setup.rb $myconf --prefix="${D}" || die "setup.rb failed"

    dosym "gem${ver_stripped}" /usr/bin/gem || die "dosym gem failed"

    dodoc README || die "dodoc README failed"
}

pkg_postinst() {
    
    source_cache="/usr/$(get_libdir)/ruby/gems/${ver}/source_cache"
    if [[ -e "${source_cache}" ]]; then
        rm "${source_cache}" || die "unable to remove src_cache"
    fi
}


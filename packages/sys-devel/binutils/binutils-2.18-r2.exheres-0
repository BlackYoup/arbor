# Copyright 2007 Bryan Ã˜stergaard
# Distributed under the terms of the GNU General Public License v2

require multilib

SUMMARY="Collection of binary tools including ld and as"
HOMEPAGE="http://www.gnu.org/software/binutils"
DOWNLOADS="mirror://gnu/${PN}/${PNV}.tar.bz2"

LICENCES="GPL-2"
SLOT="0"
PLATFORMS="~amd64 ~ia64 ~ppc64 ~x86"
MYOPTIONS=""

DEPENDENCIES=""

DEFAULT_SRC_PREPARE_PATCHES=(
    "${FILES}/76_all_use-new-ld-dtags.patch"
)
DEFAULT_SRC_CONFIGURE_PARAMS=( --host=${CHOST} )

src_install() {
    default

    # Construct env.d/binutils configuration
    mkdir -p "${IMAGE}/etc/env.d/binutils"

    insinto /etc/env.d/binutils
    cat <<EOF > binutils.env
TARGET="${CHOST}"
VER="${PV}"
LIBPATH="/usr/$(get_libdir)/${PN}/${CHOST}-${PV}"
FAKE_TARGETS="${CHOST}"
EOF
    newins binutils.env ${CHOST}-${PV}

    # Make sure a binutils version is selected for ${CHOST}
    if [[ ! -e "${IMAGE}/etc/env.d/${PN}/config-${CHOST}" ]]; then
        cat <<EOF > "${IMAGE}/etc/env.d/${PN}/config-${CHOST}"
CURRENT="${PV}"
EOF
    fi

    for f in "${IMAGE}"/usr/${CHOST}/bin/* ; do
        target=${f#${IMAGE}}
        name=${f##*/}
        dosym ${target} /usr/bin/${CHOST}-${name}
        dosym ${target} /usr/bin/${name}
     done
}


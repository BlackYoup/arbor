# Copyright 2008 Bryan Ã˜stergaard <kloeri@exherbo.org>
# Copyright 2008, 2009 Ingmar Vanhassel <ingmar@exherbo.org>
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'subversion-1.4.6-r2.ebuild' from Gentoo, which is:
#     Copyright 1999-2008 Gentoo Foundation.

SUPPORTED_AUTOCONF=( 2.5 )
SUPPORTED_AUTOMAKE=( none ) # Doesn't use automake

require bash-completion autotools perl-module python

SUMMARY="Popular version control system"
HOMEPAGE="http://subversion.tigris.org/"
DOWNLOADS="http://${PN}.tigris.org/downloads/${PNV}.tar.bz2"

REMOTE_IDS="freshmeat:${PN}"
UPSTREAM_CHANGELOG="http://svn.collab.net/repos/svn/tags/${PV}/CHANGES"
UPSTREAM_RELEASE_NOTES="http://${PN}.tigris.org/svn_${PV:0:3}_releasenotes.html"
UPSTREAM_DOCUMENTATION="http://svnbook.red-bean.com/"

LICENCES="Apache-1.1"
SLOT="0"
MYOPTIONS="berkdb nls perl python ruby slowtests"

RESTRICT="!slowtests? ( test )"

DEPENDENCIES="
    build:
        nls? ( sys-devel/gettext )
        perl? ( dev-lang/swig[perl] )
        python? ( dev-lang/swig[python] )
        ruby? ( dev-lang/swig[ruby] )
        slowtests? ( >=dev-lang/python-2.2:* )
    build+run:
        dev-libs/apr-util[berkdb?]
        net-misc/neon[~0.25.0|~0.25.1|~0.25.2|~0.25.3|~0.25.4|~0.25.5|~0.26.0|~0.26.1|~0.26.2|~0.26.3|~0.26.4|~0.27.2|~0.28.0|~0.28.1|~0.28.2|~0.28.3]
        berkdb? ( >=sys-libs/db-4.0.14:= )
        perl? ( dev-lang/perl:= )
        python? ( dev-lang/python:= )
        ruby? ( dev-lang/ruby:= )
    run:
        perl? ( dev-perl/URI )
    post,suggested:
        net-misc/neon[ssl] [[ description = [ Enables support for https:// URIs ] ]]
        net-misc/openssh [[ description = [ Enables support for svn+ssh:// URIs ] ]]"

DEFAULT_SRC_PREPARE_PATCHES=(
    "${FILES}/${PN}-perl-vendor.patch"
    "${FILES}/${PN}-perl-ccopts.patch"
)

src_prepare() {
    default
    eautoconf # Doesn't use automake
}

src_configure() {
    if option perl || option python || option ruby; then
        myconf+=" --with-swig"
    else
        myconf+=" --without-swig"
    fi

    econf \
        ${myconf} \
        $(option_with berkdb berkeley-db) \
        $(option_enable nls)
}

src_compile() {
    default
    option perl && emake swig-pl
    option python && emake swig-py
    option ruby && emake swig-rb
}

src_install() {
    default

    if option perl; then
        emake DESTDIR="${IMAGE}" install-swig-pl
        fixlocalpod
    fi

    if option python; then
        python_version
        PYTHON_DIR=/usr/$(get_libdir)/python${PYVER}

        emake DESTDIR="${IMAGE}" DISTUTIL_PARAM="--prefix=${IMAGE}" LD_LIBRARY_PATH="-L${IMAGE}/usr/$(get_libdir)" install-swig-py

        dodir "${PYTHON_DIR}/site-packages"
        mv "${IMAGE}"/usr/$(get_libdir)/svn-python/svn "${IMAGE}${PYTHON_DIR}/site-packages"
        mv "${IMAGE}"/usr/$(get_libdir)/svn-python/libsvn "${IMAGE}${PYTHON_DIR}/site-packages"
        rm -Rf "${IMAGE}"/usr/$(get_libdir)/svn-python
    fi

    if option ruby; then
        emake DESTDIR="${IMAGE}" install-swig-rb
    fi

    dobashcompletion tools/client-side/bash_completion
}

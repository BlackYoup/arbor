# Copyright 2008, 2009, 2010 Ingmar Vanhassel <ingmar@exherbo.org>
# Copyright 2011 Timo Gurr <tgurr@exherbo.org>
# Distributed under the terms of the GNU General Public License v2

require cmake systemd-service easy-multibuild

export_exlib_phases pkg_pretend src_install src_prepare

MYSQL_MAJOR_VERSION=$(ever range 1-2)

SUMMARY="A relational database management system (RDBMS)"
HOMEPAGE="http://www.mysql.com/"
DOWNLOADS="
mirror://mysql/Downloads/MySQL-$(ever range 1-2)/${PNV}.tar.gz
http://downloads.mysql.com/archives/${PN}-$(ever range 1-2)/${PNV}.tar.gz
"

REMOTE_IDS="freshmeat:${PN}"
UPSTREAM_CHANGELOG="
http://dev.mysql.com/doc/refman/${MYSQL_MAJOR_VERSION}/en/news-$(ever replace_all '-').html
"
UPSTREAM_DOCUMENTATION="
http://dev.mysql.com/doc/refman/${MYSQL_MAJOR_VERSION}/en/index.html               [[ lang = [ en ] ]]
http://dev.mysql.com/doc/refman/${MYSQL_MAJOR_VERSION}/en/post-installation.html   [[ lang = [ en ] note = [ Post installation documentation ] ]]
"

LICENCES="GPL-2" # with-exceptions
SLOT="0"
MYOPTIONS="baselayout debug tcpd
    embedded-server [[ description = [ The embedded MySQL server library, a full-featured MySQL server that can be run inside a client application ] ]]
    multibuild_c: 32 64
"

DEPENDENCIES="
    build+run:
        group/${PN}
        user/${PN}
        dev-libs/libaio[multibuild_c:*(-)?]
        dev-libs/openssl[>=0.9.7][multibuild_c:*(-)?]
        sys-libs/readline[>=5.2][multibuild_c:*(-)?]
        sys-libs/zlib[>=1.2.3][multibuild_c:*(-)?]
        tcpd? ( sys-apps/tcp-wrappers[multibuild_c:*(-)?] )
    suggestion:
        app-admin/logrotate [[ description = [ Use logrotate for rotating logs ] ]]
"

mysql-5.5_pkg_pretend() {
    # Sanity check when upgrading to a different x.y version of mysql
    if [[ -z ${MYSQL_MAJOR_UPGRADE} ]] && has_version ${CATEGORY}/${PN} && \
        ! has_version ${CATEGORY}/${PN}[=${MYSQL_MAJOR_VERSION}*] ; then
        ewarn "To install a different major version of MySQL, you have to dump/reload your database."
        ewarn "When you've done this, please set 'MYSQL_MAJOR_UPGRADE=YesPlease', to continue the upgrade."
        ewarn "For more information visit:"
        ewarn "http://dev.mysql.com/doc/refman/${MYSQL_MAJOR_VERSION}/en/upgrading.html"
        ewarn "http://dev.mysql.com/doc/refman/${MYSQL_MAJOR_VERSION}/en/downgrading.html"
        die "Dump your databases before doing a major version upgrade of MySQL."
    fi

    if [[ -f "${ROOT}"/etc/tmpfiles.d/${PN}.conf ]] ; then
        ewarn "The configuration file /etc/tmpfiles.d/${PN}.conf has been moved to"
        ewarn "/usr/${LIBDIR}/tmpfiles.d/${PN}.conf and can be safely removed after upgrade"
        ewarn "if you did not make any changes to it."
    fi

    # Pending genesis integration:
    # Upgrading to any version requires starting/stopping the MySQL server.
}

mysql-5.5_src_prepare() {
    default

    # Don't treat warnings as error, debug compilation fails (MySQL 5.5.8)
    option debug && edo sed -i -e 's/-Werror//g' "${WORK}"/CMakeLists.txt
}

configure_one_multibuild() {
    local ECMAKE_BUILD_DIR="${PWD}"

    local cmakeargs=(
        -DBUILD_CONFIG:STRING=mysql_release
        -DCMAKE_BUILD_TYPE:STRING=Release
        -DCMAKE_INSTALL_PREFIX:PATH=/usr
        -DDEFAULT_CHARSET:STRING=utf8
        -DDEFAULT_COLLATION:STRING=utf8_general_ci
        -DFEATURE_SET:STRING=community
        -DINSTALL_BINDIR:PATH=bin
        -DINSTALL_DOCDIR:PATH=share/doc/${PNVR}
        -DINSTALL_DOCREADMEDIR:PATH=share/doc/${PNVR}
        -DINSTALL_INCLUDEDIR:PATH=include/mysql
        -DINSTALL_INFODIR:PATH=share/mysql/info
        -DINSTALL_LIBDIR:PATH=${LIBDIR}/mysql
        -DINSTALL_MANDIR:PATH=share/man
        -DINSTALL_MYSQLSHAREDIR:PATH=share/mysql
        -DINSTALL_PLUGINDIR:PATH=${LIBDIR}/mysql/plugin
        -DINSTALL_SBINDIR:PATH=sbin
        -DINSTALL_SCRIPTDIR:PATH=bin
        -DINSTALL_SUPPORTFILESDIR:PATH=share/doc/${PNVR}/support-files
        -DMYSQL_DATADIR:PATH=/var/lib/mysql
        -DMYSQL_UNIX_ADDR:PATH=/run/mysqld/mysqld.sock
        -DSYSCONFDIR:PATH=/etc/mysql
        -DWITH_COMMENT:STRING="Exherbo, ${PNVR}"
        -DWITH_EXTRA_CHARSETS:STRING=all
        -DWITH_INNOBASE_STORAGE_ENGINE:BOOL=TRUE
        -DWITH_LIBEDIT:BOOL=FALSE
        -DWITH_READLINE:BOOL=FALSE
        -DWITH_SSL:STRING=system
        -DWITH_VALGRIND:BOOL=FALSE
        -DWITH_ZLIB:STRING=system
        # Empty value to not install the sql-bench directory
        -DINSTALL_SQLBENCHDIR:STRING=
    )

    ecmake \
        "${cmakeargs[@]}" \
        $(cmake_have 'embedded-server EMBEDDED_PRIVILEGE_CONTROL')\
        $(cmake_with 'debug DEBUG')\
        $(cmake_with 'embedded-server EMBEDDED_SERVER')\
        $(cmake_with 'tcpd LIBWRAP')
}

compile_one_multibuild() {
    local ECMAKE_BUILD_DIR="${PWD}"
    cmake_src_compile
}

install_one_multibuild() {
    local ECMAKE_BUILD_DIR="${PWD}"
    cmake_src_install

    ! option debug && edo rmdir "${IMAGE}"/usr/${LIBDIR}/mysql/plugin/debug

    # construct ldpath for all targets
    ldpath="/usr/${LIBDIR}/${PN}${ldpath:+:${ldpath}}"
}

mysql-5.5_src_install() {
    local ldpath

    easy-multibuild_src_install

    # Contains lots of cruft & some empty dirs
    edo rm -r "${IMAGE}"/usr/{data,mysql-test}

    keepdir /etc/mysql
    edo cp "${IMAGE}"/usr/share/doc/${PNVR}/support-files/my-small.cnf "${IMAGE}"/etc/mysql/my.cnf
    edo mv "${IMAGE}"/usr/bin/mysqlaccess.conf "${IMAGE}"/etc/mysql/mysqlaccess.conf
    edo chmod 644 "${IMAGE}"/etc/mysql/mysqlaccess.conf

    keepdir /var/{lib,log}/mysql
    edo chown mysql:mysql "${IMAGE}"/var/{lib,log}/mysql
    edo chmod 755 "${IMAGE}"/var/{lib,log}/mysql

    hereenvd 46mysql <<EOF
LDPATH=${ldpath}
EOF

    insinto /etc/logrotate.d
    newins "${FILES}"/logrotate.mysql mysql

    if option baselayout ; then
        newinitd "${FILES}"/mysql.rc6 mysql
        newconfd "${FILES}"/mysql.conf.d mysql
    fi

    install_systemd_files

    if option systemd ; then
        insinto /usr/${LIBDIR}/tmpfiles.d
        hereins ${PN}.conf <<EOF
d /run/mysqld 0755 mysql mysql
EOF
    fi
}

test_one_multibuild() {
   local ECMAKE_BUILD_DIR="${PWD}"
   cmake_src_test
}


From 32b1a8704f0ff0fcd12dca360bfba3ab435578bc Mon Sep 17 00:00:00 2001
Message-Id: <32b1a8704f0ff0fcd12dca360bfba3ab435578bc.1271368837.git.alip@exherbo.org>
From: Ali Polatel <alip@exherbo.org>
Date: Fri, 16 Apr 2010 00:58:28 +0300
Subject: [PATCH] Fix address_dup(), only save bindlast if it's really bind()
Organization: Pink Floyd

---
 src/syd-net.c     |    1 +
 src/syd-syscall.c |    2 ++
 2 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/src/syd-net.c b/src/syd-net.c
index 48778f9..504796b 100644
--- a/src/syd-net.c
+++ b/src/syd-net.c
@@ -97,6 +97,7 @@ struct sydbox_addr *address_dup(const struct sydbox_addr *src)
             dest->u.saun.abstract = src->u.saun.abstract;
             dest->u.saun.exact = src->u.saun.exact;
             strncpy(dest->u.saun.sun_path, src->u.saun.sun_path, PATH_MAX);
+            dest->u.saun.rsun_path = g_strdup(src->u.saun.rsun_path);
             break;
         case AF_INET:
             dest->u.sa.netmask = src->u.sa.netmask;
diff --git a/src/syd-syscall.c b/src/syd-syscall.c
index 7563c22..c28507a 100644
--- a/src/syd-syscall.c
+++ b/src/syd-syscall.c
@@ -1029,6 +1029,8 @@ static void syscall_check_finalize(G_GNUC_UNUSED context_t *ctx, struct tchild *
     if (child->sandbox->network &&
             sydbox_config_get_network_auto_whitelist_bind() &&
             data->result == RS_ALLOW &&
+            (sflags & BIND_CALL ||
+             (sflags & DECODE_SOCKETCALL && data->socket_subcall == SOCKET_SUBCALL_BIND)) &&
             data->addr != NULL &&
             IS_SUPPORTED_FAMILY(data->addr->family)) {
         /* Store the bind address.
-- 
1.7.0.4


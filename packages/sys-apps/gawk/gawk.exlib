# Copyright 2007 Bryan Østergaard
# Copyright 2008 Bo Ørsted Andresen
# Distributed under the terms of the GNU General Public License v2

require alternatives gnu [ suffix=xz ]

SUMMARY="GNU awk implementation"

LICENCES="GPL-3"
SLOT="0"
MYOPTIONS="
    baselayout [[ description = [ Build and install filefuncs extension to /rcscripts, required by baselayout ] ]]
"

DEPENDENCIES="
    build:
        sys-devel/gettext
    build+run:
        dev-libs/gmp:=
        dev-libs/mpfr:=
        sys-libs/readline
"

# Install binaries outside /usr
DEFAULT_SRC_CONFIGURE_PARAMS=(
    --bindir=/bin
    --enable-nls
    --with-mpfr
    --with-readline
    ac_cv_libsigsegv=no # Do not link against libsigsegv
)

DEFAULT_SRC_INSTALL_EXTRA_DOCS=( FUTURES LIMITATIONS POSIX.STD )

src_prepare() {
    option baselayout && edo cp -R "${FILES}"/filefuncs-$(ever major) "${WORKBASE}"/filefuncs
}

src_compile() {
    default

    if option baselayout; then
        cd "${WORKBASE}"/filefuncs
        nonfatal emake AWKINCDIR="${WORK}" || die "filefuncs emake failed"
    fi
}

src_install() {
    default

    # don't install the same binary twice. instead use symlinks
    dodir /usr/bin
    edo rm "${IMAGE}"/bin/gawk
    dosym gawk-${PV} /bin/gawk
    dosym ../../bin/gawk /usr/bin/gawk

    if option baselayout; then
        cd "${WORKBASE}"/filefuncs
        nonfatal emake DESTDIR="${IMAGE}" LIBDIR=${LIBDIR} install || die "filefuncs emake install failed"
    fi

    alternatives_for awk ${PN} 5 \
        /usr/bin/awk ${PN} \
        /usr/share/man/man1/awk.1 ${PN}.1
}


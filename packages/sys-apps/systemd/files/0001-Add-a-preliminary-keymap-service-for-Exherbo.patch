From a514d74a9584bd66d6f35aa634138017fec0379a Mon Sep 17 00:00:00 2001
From: Wulf C. Krueger <philantrop@exherbo.org>
Date: Sun, 29 Aug 2010 17:40:23 +0200
Subject: [PATCH] Add a preliminary keymap service for Exherbo.

---
 Makefile.am                   |    4 +++-
 units/exherbo/keymap.target   |   12 ++++++++++++
 units/exherbo/keymap@.service |   22 ++++++++++++++++++++++
 3 files changed, 37 insertions(+), 1 deletions(-)
 create mode 100644 units/exherbo/keymap.target
 create mode 100644 units/exherbo/keymap@.service

diff --git a/Makefile.am b/Makefile.am
index 244dad4..b447855 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -266,7 +266,9 @@ dist_systemunit_DATA += \
 	units/exherbo/halt.service \
 	units/exherbo/killall.service \
 	units/exherbo/reboot.service \
-	units/exherbo/poweroff.service
+	units/exherbo/poweroff.service \
+	units/exherbo/keymap.target \
+	units/exherbo/keymap@.service
 endif
 
 dist_doc_DATA = \
diff --git a/units/exherbo/keymap.target b/units/exherbo/keymap.target
new file mode 100644
index 0000000..e2049fd
--- /dev/null
+++ b/units/exherbo/keymap.target
@@ -0,0 +1,12 @@
+#  This file is part of systemd.
+#
+#  systemd is free software; you can redistribute it and/or modify it
+#  under the terms of the GNU General Public License as published by
+#  the Free Software Foundation; either version 2 of the License, or
+#  (at your option) any later version.
+
+[Unit]
+Description=Key mapping
+
+[Install]
+WantedBy=multi-user.target
diff --git a/units/exherbo/keymap@.service b/units/exherbo/keymap@.service
new file mode 100644
index 0000000..b682171
--- /dev/null
+++ b/units/exherbo/keymap@.service
@@ -0,0 +1,22 @@
+#  This file is part of systemd.
+#
+#  systemd is free software; you can redistribute it and/or modify it
+#  under the terms of the GNU General Public License as published by
+#  the Free Software Foundation; either version 2 of the License, or
+#  (at your option) any later version.
+
+[Unit]
+Description=Key mapping on %I
+Before=keymap.target
+
+[Service]
+Type=oneshot
+RemainAfterExit=yes
+EnvironmentFile=/etc/conf.d/console.conf
+ExecStartPre=/usr/bin/kbd_mode -u -C /dev/%I
+ExecStart=/usr/bin/loadkeys windowkeys ${KEYMAP} -C /dev/%I
+ExecStartPost=-/usr/bin/dumpkeys | /usr/bin/loadkeys --unicode -C /dev/%I
+ExecStartPost=-/usr/bin/echo -n -e $'\033%G' > /dev/%I
+
+[Install]
+Alias=keymap.target.wants/keymap@tty1.service keymap.target.wants/keymap@tty2.service keymap.target.wants/keymap@tty3.service keymap.target.wants/keymap@tty4.service keymap.target.wants/keymap@tty5.service keymap.target.wants/keymap@tty6.service
-- 
1.7.2.2


From b3123c0027ee475a65be4e408ab8252c64527efe Mon Sep 17 00:00:00 2001
From: Dan Callaghan <djc@djc.id.au>
Date: Sun, 3 Jul 2011 17:08:11 +1000
Subject: [PATCH] obey configured prefix for tmpfiles.d and binfmt.d
Upstream: https://bugs.freedesktop.org/show_bug.cgi?id=38686

Conflicts:

	Makefile.am
---
 Makefile.am         |    5 ++++-
 src/binfmt/binfmt.c |    2 +-
 src/tmpfiles.c      |    2 +-
 3 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/Makefile.am b/Makefile.am
index 15190b4..34f0a49 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -53,6 +53,7 @@ pkgsysconfdir=$(sysconfdir)/systemd
 userunitdir=$(prefix)/lib/systemd/user
 tmpfilesdir=$(prefix)/lib/tmpfiles.d
 sysctldir=$(prefix)/lib/sysctl.d
+binfmtdir=$(prefix)/lib/binfmt.d
 usergeneratordir=$(pkglibexecdir)/user-generators
 pkgincludedir=$(includedir)/systemd
 
@@ -96,6 +97,8 @@ AM_CPPFLAGS = \
 	-DRANDOM_SEED=\"$(localstatedir)/lib/random-seed\" \
 	-DSYSTEMD_CRYPTSETUP_PATH=\"$(rootlibexecdir)/systemd-cryptsetup\" \
 	-DSYSTEM_GENERATOR_PATH=\"$(systemgeneratordir)\" \
+	-DSITE_TMPFILES_DIR=\"$(tmpfilesdir)\" \
+	-DSITE_BINFMT_DIR=\"$(binfmtdir)\" \
 	-DUSER_GENERATOR_PATH=\"$(usergeneratordir)\" \
 	-DSYSTEM_SHUTDOWN_PATH=\"$(systemshutdowndir)\" \
 	-DSYSTEMD_KBD_MODEL_MAP=\"$(pkgdatadir)/kbd-model-map\" \
@@ -1448,7 +1451,7 @@ nodist_systemunit_DATA += \
 
 binfmt-install-data-hook:
 	$(MKDIR_P) -m 0755 \
-		$(DESTDIR)$(prefix)/lib/binfmt.d \
+		$(DESTDIR)/lib/binfmt.d \
 		$(DESTDIR)$(sysconfdir)/binfmt.d \
 		$(DESTDIR)$(systemunitdir)/sysinit.target.wants
 	( cd $(DESTDIR)$(systemunitdir)/sysinit.target.wants && \
diff --git a/src/binfmt/binfmt.c b/src/binfmt/binfmt.c
index e8d6524..4e7ca84 100644
--- a/src/binfmt/binfmt.c
+++ b/src/binfmt/binfmt.c
@@ -141,7 +141,7 @@ int main(int argc, char *argv[]) {
                                     "/run/binfmt.d",
                                     "/etc/binfmt.d",
                                     "/usr/local/lib/binfmt.d",
-                                    "/usr/lib/binfmt.d",
+                                    SITE_BINFMT_DIR,
                                     NULL);
 
                 if (r < 0) {
diff --git a/src/tmpfiles.c b/src/tmpfiles.c
index 8cbce12..3947c2c 100644
--- a/src/tmpfiles.c
+++ b/src/tmpfiles.c
@@ -1274,7 +1274,7 @@ int main(int argc, char *argv[]) {
                                     "/run/tmpfiles.d",
                                     "/etc/tmpfiles.d",
                                     "/usr/local/lib/tmpfiles.d",
-                                    "/usr/lib/tmpfiles.d",
+                                    SITE_TMPFILES_DIR,
                                     NULL);
                 if (r < 0) {
                         r = EXIT_FAILURE;
-- 
1.7.8.1


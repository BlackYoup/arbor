# Copyright 2008 Saleem Abdulrasool <compnerd@compnerd.org>
# Distributed under the terms of the GNU General Purpose License v2

require gnu

SUMMARY="TLS 1.0/1.1 and SSL 3.0 Implementation"

LICENCES="GPL-3"
SLOT="0"
PLATFORMS="~amd64 ~ppc64 ~x86"
MYOPTIONS="doc"

DEPENDENCIES="
    build:
        doc? ( dev-doc/gtk-doc[>=1.1] )
    build+run:
        dev-libs/nettle[>=2.1]
        dev-libs/libtasn1[>=1.8]
        sys-libs/zlib[>=1.2.3]
"

DEFAULT_SRC_CONFIGURE_PARAMS=( --disable-guile --disable-valgrind-tests --with-zlib )
DEFAULT_SRC_CONFIGURE_OPTION_ENABLES=( 'doc gtk-doc' )

src_prepare() {
    # Source: Trond A Ekseth <troeks@gmail.com>
    # Upstream: No
    # Reason: Binding to 0.0.0.0 creates access violations under sydbox.

    # made into a sed invocation
    edo sed \
        -e '/sa_serv\.sin_addr\.s_addr/s:INADDR_ANY:htonl(INADDR_LOOPBACK):' \
        -i tests/*.c
}

src_test() {
    esandbox allow_net --connect "inet:127.0.0.1@5557"
    esandbox allow_net --connect "inet:127.0.0.1@5559"
    emake check
    esandbox disallow_net --connect "inet:127.0.0.1@5557"
    esandbox disallow_net --connect "inet:127.0.0.1@5559"
}


From 66737459c55519a32c16809a41ca64e84b1ac7a1 Mon Sep 17 00:00:00 2001
From: Simon Josefsson <simon@josefsson.org>
Date: Fri, 6 Nov 2009 17:21:43 +0100
Subject: [PATCH] Fix --disable-valgrind-tests.

---
 configure.ac   |    2 +-
 m4/valgrind.m4 |   15 +++++++++------
 2 files changed, 10 insertions(+), 7 deletions(-)

diff --git a/configure.ac b/configure.ac
index 19d87e5..bbcfc10 100644
--- a/configure.ac
+++ b/configure.ac
@@ -296,7 +296,7 @@ AC_MSG_NOTICE([summary of build options:
   Compiler:         ${CC}
   Warning flags:    errors: ${WERROR_CFLAGS} warnings: ${WARN_CFLAGS}
   Library types:    Shared=${enable_shared}, Static=${enable_static}
-  Valgrind:         ${VALGRIND}
+  Valgrind:         $opt_valgrind_tests ${VALGRIND}
   Guile wrappers:   $opt_guile_bindings
   C++ library:      $use_cxx
   OpenSSL library:  $enable_openssl
diff --git a/m4/valgrind.m4 b/m4/valgrind.m4
index 5a8006a..e22370f 100644
--- a/m4/valgrind.m4
+++ b/m4/valgrind.m4
@@ -1,4 +1,4 @@
-# valgrind.m4 serial 1
+# valgrind.m4 serial 2
 dnl Copyright (C) 2008, 2009 Free Software Foundation, Inc.
 dnl This file is free software; the Free Software Foundation
 dnl gives unlimited permission to copy and/or distribute it,
@@ -11,20 +11,23 @@ dnl From Simon Josefsson
 # Check if valgrind is available, and set VALGRIND to it if available.
 AC_DEFUN([sj_VALGRIND],
 [
+  AC_ARG_ENABLE(valgrind-tests,
+    AS_HELP_STRING([--enable-valgrind-tests],
+                   [run self tests under valgrind]),
+    [opt_valgrind_tests=$enableval], [opt_valgrind_tests=yes])
+
   # Run self-tests under valgrind?
-  if test "$cross_compiling" = no; then
+  if test "$opt_valgrind_tests" = "yes" && test "$cross_compiling" = no; then
     AC_CHECK_PROGS(VALGRIND, valgrind)
   fi
+
   if test -n "$VALGRIND" && $VALGRIND true > /dev/null 2>&1; then
     opt_valgrind_tests=yes
   else
     opt_valgrind_tests=no
     VALGRIND=
   fi
+
   AC_MSG_CHECKING([whether self tests are run under valgrind])
-  AC_ARG_ENABLE(valgrind-tests,
-    AS_HELP_STRING([--enable-valgrind-tests],
-                   [run self tests under valgrind]),
-    opt_valgrind_tests=$enableval)
   AC_MSG_RESULT($opt_valgrind_tests)
 ])
-- 
1.6.6


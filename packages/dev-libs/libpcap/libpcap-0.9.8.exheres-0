# Copyright (c) 2007 Alexander Færøy <ahf@exherbo.org>
# Distributed under the terms of the GNU General Public License v2
#
# This is highly inspired from Gentoo's ebuild which is:
#   Copyright 1999-2007 Gentoo Foundation
#

require toolchain-funcs

DESCRIPTION="A library for network packet capturing"
HOMEPAGE="http://www.tcpdump.org/"
SRC_URI="http://www.tcpdump.org/release/${P}.tar.gz"

LICENSE="BSD"
SLOT="0"
PLATFORMS="~x86"
MYOPTIONS="ipv6"

DEPENDENCIES=""

#
# We have to do this because libpcap is retarded.
#
make_shared_object() {
    $(tc-getCC) ${LDFLAGS} ${LDFLAGS} -Wl,-soname,libpcap.so.0 -shared -fPIC -o libpcap.so.${PV:0:3} *.o \
        || die "Unable to generate shared object file"
}

install_shared_object() {
    insopts -m 755
    insinto /usr/$(get_libdir)/
    doins libpcap.so.${PV:0:3}
    dosym libpcap.so.${PV:0:3} /usr/$(get_libdir)/libpcap.so.0
    dosym libpcap.so.${PV:0:3} /usr/$(get_libdir)/libpcap.so
}

src_compile() {
    econf $(option_enable ipv6) || die "econf failed"
    emake || die "emake failed"

    make_shared_object
}

src_install() {
    emake DESTDIR="${D}" install || die "emake install failed"

    install_shared_object

    dodoc README.linux CREDITS VERSION TODO FILES CHANGES
}

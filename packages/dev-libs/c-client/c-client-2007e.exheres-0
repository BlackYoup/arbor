# Copyright 2009 Wulf C. Krueger <philantrop@exherbo.org>
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'c-client-2007e.ebuild' from Gentoo, which is:
#     Copyright 1999-2009 Gentoo Foundation

require flag-o-matic multilib

MY_PNV=imap-${PV}
SUMMARY="UW IMAP c-client library"
HOMEPAGE="http://www.washington.edu/imap/"
DOWNLOADS="ftp://ftp.cac.washington.edu/imap/${MY_PNV}.tar.gz"

BUGS_TO="philantrop@exherbo.org"

LICENCES="as-is"
SLOT="0"
PLATFORMS="~amd64"
MYOPTIONS="pam ssl"

DEPENDENCIES="
    build+run:
        pam? ( >=sys-libs/pam-0.72 )
        ssl? ( >=dev-libs/openssl-0.9.8j )
"

DEFAULT_SRC_PREPARE_PATCHES=(
    -p1 "${FILES}"/${PN}-build-needed.patch
    -p1 "${FILES}"/${PN}-build-so.patch
)

WORK="${WORKBASE}"/${MY_PNV}

src_prepare() {
    default

    # lots of things need -fPIC, including various platforms, and this library
    # generally should be built with it anyway.
    append-flags -fPIC

    # Modifications so we can build it correctly.
    sed \
        -e "s:BASECFLAGS=\".*\":BASECFLAGS=:g" \
        -e 's:SSLDIR=/usr/local/ssl:SSLDIR=/usr:g' \
        -e 's:SSLCERTS=$(SSLDIR)/certs:SSLCERTS=/etc/ssl/certs:g' \
        -i src/osdep/unix/Makefile || die "Makefile sed fixing failed"

    # Remove the pesky checks about SSL stuff
    sed -e '/read.*exit/d' -i Makefile
}

src_compile() {
    local ssltype target

    option ssl && ssltype="unix" || ssltype="none"
    option pam && target=lnp || target=lnx

    # no parallel builds supported!
    emake -j1 $target SSLTYPE=${ssltype} EXTRACFLAGS="${CFLAGS}"
}

src_install() {
    into /usr

    # Library binary
    dolib.a c-client/c-client.a
    dosym c-client.a /usr/$(get_libdir)/libc-client.a
    dolib.so c-client/libc-client.so.1.0.0

    # Headers
    insinto /usr/include/imap
    doins c-client/*.h
    doins c-client/linkage.c
    #exclude these dupes (can't do it before now due to symlink hell)
    rm "${IMAGE}"/usr/include/imap/os_*.h || die "removing cruft failed"

    # Docs
    dodoc README docs/*.txt docs/CONFIG docs/RELNOTES
}

# Copyright 2007 Bryan Ã˜stergaard
# Distributed under the terms of the GNU General Public License v2

require easy-multibuild [ work=${PNV} ]

SUMMARY="Open source SSL and TLS implementation and cryptographic library"
HOMEPAGE="http://www.openssl.org"
DOWNLOADS="${HOMEPAGE}/source/${PNV}.tar.gz"

REMOTE_IDS="freecode:${PN}"

UPSTREAM_CHANGELOG="${HOMEPAGE}/news/changelog.html [[ lang = en ]]"
UPSTREAM_DOCUMENTATION="${HOMEPAGE}/docs/ [[ lang = en ]]"
UPSTREAM_RELEASE_NOTES="${HOMEPAGE}/news/announce.html [[ lang = en ]]"

LICENCES="${PN}"
SLOT="0"
PLATFORMS="~amd64 ~arm ~ia64 ~ppc64 ~x86"
MYOPTIONS="platform: ppc64 multibuild_c: 32 64"

DEPENDENCIES=""

DEFAULT_SRC_PREPARE_PATCHES=(
    "${FILES}"/${PN}-0.9.8o-CFLAGS.patch
)
# Tests don't run in parallel
DEFAULT_SRC_TEST_PARAMS=( -j1 )

WORK="${WORKBASE}"

unpack_prepare_one_multibuild() {
    edo mkdir -p "${WORKBASE}/${MULTIBUILD_CLASS}/${MULTIBUILD_TARGET}"
}

src_unpack() {
    easy-multibuild_run_phase
}

src_prepare() {
    easy-multibuild_run_phase
}

configure_prepare_one_multibuild() { :; }

configure_one_multibuild() {
    edo ./config --test-sanity

    # ppc64 needs to be configured manually with Configure instead of config.
    if option platform:ppc64; then
        edo ./Configure linux-ppc64 --prefix=/usr --openssldir=/etc/ssl shared threads
    elif option multibuild_c:32 && [[ "${MULTIBUILD_CLASS}${MULTIBUILD_TARGET}" == "C32" ]]; then
        edo ./Configure linux-elf --prefix=/usr --openssldir=/etc/ssl shared threads
    else
        edo ./config --prefix=/usr --openssldir=/etc/ssl shared threads
    fi
}

compile_one_multibuild() {
    # Parallel build is broken
    emake -j1 LIBDIR=${LIBDIR} MANDIR=/usr/share/man
}

install_one_multibuild() {
    emake -j1 INSTALL_PREFIX="${IMAGE}" LIBDIR=${LIBDIR} MANDIR=/usr/share/man install
    keepdir /etc/ssl/{certs,private}
    emagicdocs
}


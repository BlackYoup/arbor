# Copyright 2007 Bryan Ã˜stergaard
# Distributed under the terms of the GNU General Public License v2

require easy-multibuild [ work=${PNV} ]

SUMMARY="Open source SSL and TLS implementation and cryptographic library"
HOMEPAGE="http://www.openssl.org"
DOWNLOADS="${HOMEPAGE}/source/${PNV}.tar.gz"

REMOTE_IDS="freecode:${PN}"

UPSTREAM_CHANGELOG="${HOMEPAGE}/news/changelog.html [[ lang = en ]]"
UPSTREAM_DOCUMENTATION="${HOMEPAGE}/docs/ [[ lang = en ]]"
UPSTREAM_RELEASE_NOTES="${HOMEPAGE}/news/announce.html [[ lang = en ]]"

LICENCES="${PN}"
SLOT="0"
PLATFORMS="~amd64 ~arm ~x86"
MYOPTIONS="
    multibuild_c: 32 64
    platform: amd64 arm x86
"

DEPENDENCIES="
    build+run:
        !dev-libs/libressl [[
            description = [ LibreSSL is a drop-in replacement for OpenSSL with same library name ]
            resolution = uninstall-blocked-after
        ]]
"

DEFAULT_SRC_PREPARE_PATCHES=(
    "${FILES}"/${PN}-0.9.8o-CFLAGS.patch
    "${FILES}"/1b4a8df38fc9ab3c089ca5765075ee53ec5bd66a.patch
    "${FILES}"/28a00bcd8e318da18031b2ac8778c64147cd54f9.patch
)
# Tests don't run in parallel
DEFAULT_SRC_TEST_PARAMS=( -j1 )

WORK="${WORKBASE}"

unpack_prepare_one_multibuild() {
    edo mkdir -p "${WORKBASE}/${MULTIBUILD_CLASS}/${MULTIBUILD_TARGET}"
}

src_unpack() {
    easy-multibuild_run_phase
}

src_prepare() {
    easy-multibuild_run_phase
}

configure_prepare_one_multibuild() { :; }

configure_one_multibuild() {
    edo ./config --test-sanity

    # TODO(compnerd) always use Configure rather than config
    if option multibuild_c:32 && [[ "${MULTIBUILD_CLASS}${MULTIBUILD_TARGET}" == "C32" ]]; then
        local configuration=
        # local configuration=(
        #   alpha64:linux-alpha-gcc # TODO(compnerd) Alpha64 ev56+ needs -mcpu, linux-alpha+bwx-gcc
        #   armd64:linux-x86_64
        #   arm:linux-armv4 # TODO(compnerd) do we want to port android armv7 to Linux?
        #   ia64:linux-ia64 # TODO(compnerd) ICC should be linux-ia64-icc
        #   ppc:linux-ppc
        #   ppc64:linux-ppc64
        #   s390:linux${MULTIBUILD_TARGET}-s390x
        #   sparc:linux-sparcv9 # XXX(compnerd) do we even care about sparc v8?
        #   sparc64:linux64-sparcv9
        #   x86:linux-elf # TODO(compnerd) ICC should be linux-ia32-icc
        # )

        if option platform:arm ; then
            configuration=linux-armv4
        elif option platform:amd64 || option platform:x86 ; then
            configuration=linux-elf
        else
            die "unsupported platform"
        fi

        edo ./Configure ${configuration} --prefix=/usr --openssldir=/etc/ssl shared threads
    else
        edo ./config --prefix=/usr --openssldir=/etc/ssl shared threads
    fi
}

compile_one_multibuild() {
    # Parallel build is broken
    emake -j1 LIBDIR=${LIBDIR} MANDIR=/usr/share/man
}

install_one_multibuild() {
    emake -j1 INSTALL_PREFIX="${IMAGE}" LIBDIR=${LIBDIR} MANDIR=/usr/share/man install
    keepdir /etc/ssl/{certs,private}
    emagicdocs
}


# Copyright 2007 Bryan Ã˜stergaard
# Distributed under the terms of the GNU General Public License v2

require multilib

SUMMARY="Open source SSL and TLS implementation and cryptographic library"
HOMEPAGE="http://www.openssl.org"
DOWNLOADS="http://www.openssl.org/source/${PNV}.tar.gz"

LICENCES="BSD-3"
SLOT="0"
PLATFORMS="~amd64 ~arm ~ia64 ~ppc64 ~x86"
MYOPTIONS="platform: ppc64"

DEPENDENCIES=""

DEFAULT_SRC_PREPARE_PATCHES=(
    "${FILES}"/${PNV}-CFLAGS.patch
    "${FILES}"/${PNV}-remove-broken-configs.patch
    )
# Parallel build is broken
DEFAULT_SRC_COMPILE_PARAMS=( -j1 )
# Tests don't run in parallel
DEFAULT_SRC_TEST_PARAMS=( -j1 )

src_prepare() {
    default

    # Fix libdir
    edo sed -e "s:\(\$(INSTALL_PREFIX)\$(INSTALLTOP)\)/lib:\1/$(get_libdir):g" \
            -e "/libdir=/s:/lib:/$(get_libdir):g" \
            -i Makefile.org engines/Makefile

    # Fix manpath
    edo sed -e 's:^MANDIR=.*$:MANDIR=/usr/share/man:' -i Makefile.org
}

src_configure() {
    edo ./config --test-sanity

    # ppc64 needs to be configured manually with Configure instead of config.
    if option platform:ppc64; then
        edo ./Configure linux-ppc64 --prefix=/usr --openssldir=/etc/ssl shared threads
    else
        edo ./config --prefix=/usr --openssldir=/etc/ssl shared threads
    fi
}

src_install() {
    emake -j1 INSTALL_PREFIX="${IMAGE}" install
    keepdir /etc/ssl/{certs,private}
    emagicdocs
}


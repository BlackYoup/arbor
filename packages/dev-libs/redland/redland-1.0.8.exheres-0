# Copyright 2008 Ingmar Vanhassel <ingmar@exherbo.org>
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'redland-1.0.8.ebuild' from Gentoo, which is:
#     Copyright 1999-2008 Gentoo Foundation.

require multilib autotools

SUMMARY="High-level interface for the Resource Description Framework"
HOMEPAGE="http://librdf.org"
SRC_URI="http://download.librdf.org/source/${P}.tar.gz"

LICENSE="|| ( LGPL-2.1 GPL-2 Apache-2.0 )"
SLOT="0"
PLATFORMS="~amd64"
MYOPTIONS="berkdb sqlite ssl" # mysql postgres

DEPENDENCIES="
    build:
        dev-util/pkg-config
    build+run:
        dev-libs/libxml2
        >=dev-libs/rasqal-0.9.16
        berkdb? ( sys-libs/db:= )
        sqlite? ( dev-db/sqlite:3 )
        ssl? ( dev-libs/openssl )"

src_prepare() {
    if option !berkdb; then
        # This test fails without berkdb
        sed -e 's: rdf_model_test::' -e '/^rdf_model_test:/{g;n;d;}' \
            -i "${S}"/librdf/Makefile.am || die "Failed to sed out rdf_model_test"
        eautomake # eautoreconf needs dev-util/gtk-doc
    fi
}

DEFAULT_SRC_CONFIGURE_PARAMS=(
    --enable-modular ## Seperate .so's for each database backends.
    --with-raptor=system
    --with-rasqal=system
    --with-xml-parser=libxml
    --without-mysql
    --without-postgresql
    --with-threads
)
DEFAULT_SRC_CONFIGURE_OPTION_WITHS=(
    "berkdb bdb"
    "ssl openssl-digests"
    "sqlite"
    "sqlite sqlite-version 3"
)

src_install() {
    default

    #  With --disable-modular, or without database backends redland leaves empty dirs:
    # [[ option mysql || option sqlite || option postgres ]] || \
    # option !sqlite && \
        rmdir "${D}"/usr/$(get_libdir)/${PN}
}


# Copyright 2007 Bryan Ã˜stergaard
# Copyright 2012 Saleem Abdulrasool <compnerd@compnerd.org>
# Distributed under the terms of the GNU General Public License v2

require gnu [ suffix=bz2 ]

SUMMARY="GNU Multiple Precision arithmetic library"
HOMEPAGE="http://${PN}lib.org"

REMOTE_IDS="freecode:${PN}"

UPSTREAM_DOCUMENTATION+="${HOMEPAGE}/manual/ [[ lang = en ]]"
UPSTREAM_RELEASE_NOTES="${HOMEPAGE}/${PN}$(ever range 1-2).html [[ lang = en ]]"

LICENCES="GPL-3 LGPL-3"
SLOT="5"
PLATFORMS="~amd64 ~arm ~ia64 ~ppc64 ~x86"

MYOPTIONS="
platform: amd64 ppc64 x86
hosts:
    arm-exherbo-linux-gnueabi
    i686-pc-linux-gnu
    x86_64-pc-linux-gnu
"

DEPENDENCIES="
    build:
        sys-devel/m4
    build+run:
        sys-libs/readline[hosts:*(-)?]
        !dev-libs/gmp:0[<4.3.2-r1] [[
            description = [ file collisions which will probably break your system ]
        ]]
"

src_configure() {
    local _platform_abis=(
        amd64:64
        ppc64:mode64
        x86:32
    )
    local host=

    for host in ${CROSS_COMPILE_TARGETS} ; do
        local abi= platform=

        if option !hosts:${host} ; then
            echo "    Cross-Compile Host: ${host} (disabled)"
            continue
        fi

        for platform in "${_platform_abis[@]}" ; do
            if option platform:${platform%:*} ; then
                abi=${platform#*:}
                break
            fi
        done

        echo "    Cross-Compile Host: ${host}"

        edo mkdir -p "${WORKBASE}/build/${host}"
        edo cd "${WORKBASE}/build/${host}"

            ABI=${abi}                              \
        edo "${WORKBASE}/${PNV}/configure"          \
                --build=${CHOST}                    \
                --host=${host}                      \
                --prefix=/usr/${host}               \
                --datarootdir=/usr/share            \
                --localstatedir=/var                \
                --sysconfdir=/etc                   \
                --enable-fast-install               \
                --enable-cxx                        \
                --enable-fft                        \
                --with-readline                     \
        || die
    done
}

src_compile() {
    local host=

    for host in ${CROSS_COMPILE_TARGETS} ; do
        if option !hosts:${host} ; then
            echo "    Cross-Compile Host: ${host} (disabled)"
            continue
        fi

        echo "    Cross-Compile Host: ${host}"
        edo cd "${WORKBASE}/build/${host}"

        default
    done
}

src_test() {
    edo cd "${WORKBASE}/build/${CHOST}"
    default
}

src_install() {
    local host=

    for host in ${CROSS_COMPILE_TARGETS} ; do
        if option !hosts:${host} ; then
            echo "    Cross-Compile Host: ${host} (disabled)"
            continue
        fi

        echo "    Cross-Compile Host: ${host}"
        edo cd "${WORKBASE}/build/${host}"

        default
    done
}


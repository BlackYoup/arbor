# Copyright 2009 Wulf C. Krueger <philantrop@exherbo.org>
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'libaio-0.3.107.ebuild' from Gentoo, which is:
#     Copyright 1999-2009 Gentoo Foundation

require debian-upstream [ debian_pv="${PV}.orig" ] multilib toolchain-funcs

SUMMARY="Asynchronous input/output library that uses the kernels native interface"
DESCRIPTION="
AIO enables even a single application thread to overlap I/O operations with other
processing, by providing an interface for submitting one or more I/O requests in
one system call (io_submit()) without waiting for completion, and a separate interface
(io_getevents()) to reap completed I/O operations associated with a given completion
group. Support for kernel AIO has been included in the 2.6 Linux kernel.
"
HOMEPAGE="http://www.kernel.org/pub/linux/kernel/people/andrea/libaio/ http://lse.sourceforge.net/io/aio.html"

BUGS_TO="philantrop@exherbo.org"

LICENCES="LGPL-2"
SLOT="0"
PLATFORMS="~amd64 ~x86"
MYOPTIONS=""
DEPENDENCIES=""

RESTRICT="userpriv"

DEFAULT_SRC_PREPARE_PATCHES=(
    -p1 "${FILES}"/${PNV}-install-to-slash.patch
    -p1 "${FILES}"/${PNV}-ar-ranlib.patch
    -p0 "${FILES}"/${PNV}-build.patch
)

src_prepare() {
    default

    sed -i "/^libdir=/s:lib$:$(get_libdir):" src/Makefile Makefile
    tc-export AR CC RANLIB
}

src_test() {
    addwrite /dev/loop
    pushd "${WORK}"/harness >/dev/null
    mkdir testdir
    emake -j1 check prefix="${WORK}/src" libdir="${WORK}/src"
    popd >/dev/null
}

src_install() {
    default

    doman man/*

    # remove stuff provided by man-pages now
    rm "${IMAGE}"usr/share/man/man3/aio_{cancel,error,fsync,read,return,suspend,write}.*
}

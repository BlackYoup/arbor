# Copyright 2009 Wulf C. Krueger <philantrop@exherbo.org>
# Distributed under the terms of the GNU General Public License v2

require toolchain-funcs multilib

MY_PNV="${PN}${PV}"

SUMMARY="${PN} is a free stand-alone ini file parsing library"
DESCRIPTION="
The ${PN} library implements the strict necessary to parse Windows-style ini
files and return the information as a dictionary of (hashed) strings.
"
HOMEPAGE="http://ndevilla.free.fr/${PN}/"
DOWNLOADS="${HOMEPAGE}/${MY_PNV}.tar.gz"

BUGS_TO="philantrop@exherbo.org"
REMOTE_IDS="freshmeat:inifileparser"

UPSTREAM_CHANGELOG="${HOMEPAGE}/ChangeLog"
UPSTREAM_DOCUMENTATION="${HOMEPAGE}/html/index.html [[ lang = en ]]"

LICENCES="MIT"
SLOT="0"

PLATFORMS="~amd64 ~x86"
MYOPTIONS=""
DEPENDENCIES=""

WORK="${WORKBASE}/${MY_PNV}"

src_prepare() {
    sed \
        -e "s:^\(CC .*=\) .*:\1 $(tc-getCC):" \
        -e "s:^\(CFLAGS .*=\) -O2:\1 ${CFLAGS}:" \
        -e "s:^\(AR\t .*=\) .*:\1 $(tc-getAR):" \
        -e "s:^\(LDFLAGS = .*\):\1 ${LDFLAGS}:" \
        -e "s:/usr/lib:/usr/$(get_libdir):g" \
        -i Makefile \
        -i test/Makefile \
        || die "sed to change the Makefile failed"
}

src_test() {
    emake -j1 check
    pushd test >/dev/null
    ./iniexample || die "iniexample test failed"
    ./parse || die "parser torture test failed"
    popd >/dev/null
}

src_install() {
    dolib \
        libiniparser.a \
        libiniparser.so.0

    dosym libiniparser.so.0 /usr/$(get_libdir)/libiniparser.so

    insinto /usr/include
    doins src/*.h

    dodoc AUTHORS README
}

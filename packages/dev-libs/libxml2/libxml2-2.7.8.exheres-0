# Copyright 2007-2008 Bo Ã˜rsted Andresen
# Distributed under the terms of the GNU General Public License v2

require python easy-multibuild autotools [ supported_autoconf=[ 2.5 ] supported_automake=[ 1.11 ] ]

SUMMARY="XML C Parser and Toolkit v2"
HOMEPAGE="http://www.xmlsoft.org/"
BASE_URI="http://www.w3.org/XML"
SCHEMA_TEST_URI="${BASE_URI}/2004/xml-schema-test-suite/xmlschema"
TEST_VERSION="20080827"
TAR1="2002-01-16"
TAR2="2004-01-14"
DOWNLOADS="ftp://www.xmlsoft.org/${PN}/${PNV}.tar.gz
    ${BASE_URI}/Test/xmlts${TEST_VERSION}.tar.gz
    ${SCHEMA_TEST_URI}${TAR1}/xsts-${TAR1}.tar.gz
    ${SCHEMA_TEST_URI}${TAR2}/xsts-${TAR2}.tar.gz"

UPSTREAM_RELEASE_NOTES="${HOMEPAGE}/news.html"
UPSTREAM_CHANGELOG="${HOMEPAGE}/ChangeLog.html"

LICENCES="MIT"
SLOT="2.0"
PLATFORMS="~amd64 ~arm ~ppc64 ~x86"
MYOPTIONS="python readline
    multibuild_c: 32 64"

DEPENDENCIES="
    build+run:
        sys-libs/zlib[>=1.2.5-r1]
        python? ( dev-lang/python:= )
        readline? ( sys-libs/readline[multibuild_c:*(?)?] )
"

DEFAULT_SRC_PREPARE_PATCHES=( "${FILES}/0001-Reactivate-the-shared-library-versionning-script.patch" )
DEFAULT_SRC_CONFIGURE_OPTION_WITHS=( python readline "readline history" )
DEFAULT_SRC_INSTALL_EXTRA_DOCS=( README.tests TODO_SCHEMAS )

pkg_pretend() {
    if option multibuild_c:32 && option python; then
        ewarn "The 32bit python portion in libxml2 needs a 32bit python,"
        ewarn "which is not available yet. The 32bit libxml2 will be built"
        ewarn "without python support."
    fi
}

src_unpack() {
    unpack ${PNV}.tar.gz

    # test suite
    unpack xmlts${TEST_VERSION}.tar.gz
    edo mv "${WORKBASE}/xmlconf" "${WORK}"
}

src_prepare() {
    # prevent fetching with wget during src_test
    edo ln -s "${FETCHEDDIR}"/xsts-{${TAR1},${TAR2}}.tar.gz xstc/
    autotools_src_prepare
}

configure_one_multibuild() {
    local myconf
    if ! multibuild_default_target C; then
        # Needs 32bit python
        myconf+="--without-python"
    fi

    econf \
        --with-threads \
        --enable-ipv6 \
        --without-icu \
        $(option_with python) \
        $(option_with readline) \
        $(option_with readline history) \
        "${myconf}"
}

test_one_multibuild() {
    # tests don't support out-of-source builds
    edo ln -s "${WORK}"/{result,test} .
    default
}

install_one_multibuild() {
    # devhelp doesn't support out-of-source builds
    edo cp -pPR "${WORK}"/doc/devhelp/* doc/devhelp/
    default
    if multibuild_default_target C; then
        # python part disabled for 32bit
        option python && python_bytecompile
    fi
}


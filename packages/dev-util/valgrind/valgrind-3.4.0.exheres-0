# Copyright 2008 Ingmar Vanhassel <ingmar@exherbo.org>
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'valgrind-3.3.0.ebuild' from Gentoo, which is:
#     Copyright 1999-2008 Gentoo Foundation.

SUPPORTED_AUTOCONF=( 2.5 )
SUPPORTED_AUTOMAKE=( 1.10 )

require autotools flag-o-matic toolchain-funcs

SUMMARY="An open-source memory debugger for GNU/Linux"
HOMEPAGE="http://www.valgrind.org"
DOWNLOADS="http://www.valgrind.org/downloads/${PNV}.tar.bz2"

UPSTREAM_RELEASE_NOTES="${HOMEPAGE}/docs/manual/dist.news.html"

LICENCES="GPL-2"
SLOT="0"
PLATFORMS="-* ~amd64 ~x86"
MYOPTIONS="platform: amd64"

DEPENDENCIES=""

DEFAULT_SRC_PREPARE_PATCHES=( "${FILES}/${PNV}-pkg-config.patch" )

src_prepare() {
    sed -e 's:^CFLAGS="-Wno-long-long":& $CFLAGS:' \
        -i configure.in #|| die "CFLAGS sed failed"
    sed -e "s:doc/${PN}:doc/${PNV}:" \
        -i docs/Makefile.am || "docs sed failed"

    autotools_src_prepare
}

src_configure() {
    filter-flags -fomit-frame-pointer
    # -ggdb3 causes segfaults at startup
    replace-flags -ggdb3 -ggdb2

    # FIXME multilib: option platform:amd64 && ! has_multilib_profile
    if option platform:amd64; then
        myconf='--enable-only64bit'
    fi

    econf ${myconf}
}


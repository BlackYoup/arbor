# Copyright 2007, 2008 Bryan Ã˜stergaard
# Copyright 2008 Anders Ossowicki
# Copyright 2008 Ingmar Vanhassel
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'perl-5.8.8-r4.ebuild' from Gentoo, which is:
#     Copyright 1999-2007 Gentoo Foundation

require multilib versionator

export_exlib_phases src_prepare src_configure src_install pkg_postinst

SUMMARY="Perl is a general-purpose programming language originally developed for text manipulation"
HOMEPAGE="http://www.perl.org"

REMOTE_IDS="cpan:${PN} freshmeat:${PN}"

UPSTREAM_CHANGELOG="http://search.cpan.org/dist/${PN}/pod/${PN}${PV//.}delta.pod"
UPSTREAM_DOCUMENTATION=

LICENCES="|| ( Artistic GPL GPL-2 GPL-3 )"
SLOT="$(get_version_component_range 1-2)"
MYOPTIONS=""

DEPENDENCIES="
    build+run:
        dev-perl/Pod-Parser"

DEFAULT_SRC_INSTALL_EXTRA_DOCS=( Changes5 )

# WORK="${TEMP}/build"
WORK="${WORKBASE}/build"

perl-5_src_prepare() {
    cd "${WORKBASE}/${PNV}"
    default
    mkdir "${WORK}" || die "mkdir failed"
}

perl-5_src_configure() {
    # Binaries are installed to /usr/bin/, with ${PV} appended
    # Alternatives manages executables in /usr/bin/
    # Libraries go into /usr/$(get_libdir)/${PN}${PV%%.*}/${PV}/${CHOST%%-*}/CORE/, which is appended to LDPATH
    # `man 1` are installed with a version

    # -Dfoo = define foo, -Ufoo = undefine foo.
    
    sh "${WORKBASE}/${PNV}/Configure" \
        -des \
        -Dcf_by='Exherbo' \
        -Dprefix=/usr \
        -Dvendorprefix=/usr \
        -Dsiteprefix=/usr \
        -Doptimize="${CFLAGS}" \
        -Darchname=${CHOST%%-*} \
        -Dlibperl="libperl.so.1.${PV}" \
        -Uinstallusrbinperl= \
        -Duseshrplib \
        -Dmksymlinks \
        -Duselargefiles \
        "${PERL5_CONFIGURE_PARAMS[@]}" \
        || die "Configure failed"
}

perl-5_src_install() {
    default

    # Library symlinks
    local perllibdir=/usr/$(get_libdir)/${PN}${PV%%.*}/${PV}/${CHOST%%-*}/CORE/
    dosym ${perllibdir}/libperl.so.1{.${PV},}
    dosym ${perllibdir}/libperl.so{.1,}

    # We only want /usr/bin/perl5.8.8, not /usr/bin/perl (without the dash, standard across distros)
    # with -Uinstallusrbinperl this shouldn't even get installed, but it does happen anyway, for some reason..
    if [[ -f "${IMAGE}"/usr/bin/${PN} ]]; then
        rm "${IMAGE}"/usr/bin/${PN} || die "Couldn't remove /usr/bin/${PN}"
    fi

    # Version executables
    local executable
    for executable in "${IMAGE}"/usr/bin/*; do
        if [[ ${executable##*/} != *${PV} ]]; then
            mv "${executable}" "${executable}-${PV}" || die "Failed to version ${executable/${IMAGE}}"
        fi
    done

    # Version man1 manpages, discard man3 manpages (use perldoc)
    rm -r "${IMAGE}"/usr/share/man/man3 || die "Couldn't remove man 3 manpages"
    local manpage
    for manpage in "${IMAGE}"/usr/share/man/man1/*.1; do
        mv "${manpage}" "${manpage/.1/-${PV}.1}" || die "Failed to version ${manpage/${IMAGE}}"
    done

    keepdir /usr/$(get_libdir)/${PN}${PV%%.*}/{site,vendor}_perl/${PV}/${CHOST%%-*}

    dodir /etc/env.d/${PN}
    cat <<EOF > "${IMAGE}"/etc/env.d/${PN}/${PV}
LDPATH="${perllibdir}"
EOF

    # Save a list of what executables & man-pages we're installing
    cd "${IMAGE}"
    PERL5_ALTERNATIVES_FILES+=( ./usr/bin/*${PV} ./usr/share/man/man1/*${PV}.1 )
}

perl-5_pkg_postinst() {
    local f target
    for f in "${PERL5_ALTERNATIVES_FILES[@]#.\/}"; do
        [[ ${f/-${PV}} == ${f} ]] && target=${ROOT}${f/${PV}} || target=${ROOT}${f/-${PV}}
        echo ln -sf ${f##*/} "${target}"
        ln -sf ${f##*/} "${target}" || ewarn "Couldn't create ${target}"
    done
}


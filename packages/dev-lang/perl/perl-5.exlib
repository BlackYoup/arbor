# Copyright 2007, 2008 Bryan Ã˜stergaard
# Copyright 2008 Anders Ossowicki
# Copyright 2008, 2009 Ingmar Vanhassel
# Copyright 2008 Mike Kelly
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'perl-5.8.8-r4.ebuild' from Gentoo, which is:
#     Copyright 1999-2007 Gentoo Foundation

require multilib alternatives flag-o-matic

export_exlib_phases src_unpack src_prepare src_configure src_test src_install

myexparam Module_Build_pv=

SUMMARY="Perl is a general-purpose programming language originally developed for text manipulation"
HOMEPAGE="http://www.perl.org"

REMOTE_IDS="cpan:${PN} freshmeat:${PN}"

UPSTREAM_CHANGELOG="http://search.cpan.org/dist/${PN}/pod/${PN}${PV//.}delta.pod"
UPSTREAM_DOCUMENTATION=

LICENCES="|| ( Artistic GPL GPL-2 GPL-3 )"
SLOT="$(ever range 1-2)"
MYOPTIONS="berkdb gdbm"

DEPENDENCIES="
    build+run:
        berkdb? ( sys-libs/db:= )
        gdbm? ( sys-libs/gdbm )
"

DEFAULT_SRC_INSTALL_EXTRA_DOCS=( Changes5 )

# WORK="${TEMP}/build"
WORK="${WORKBASE}/build"

db_define() {
    option "${1}" && echo 'D' || echo 'U'
}

perl-5_src_unpack() {
    default
    mkdir "${WORK}" || die "mkdir failed"
}

perl-5_src_prepare() {
    cd "${WORKBASE}/${PNV}"
    default
}

perl-5_src_configure() {
    # Binaries are installed to /usr/bin/, with ${PV} appended
    # Alternatives manages executables in /usr/bin/
    # Libraries go into /usr/$(get_libdir)/${PN}${PV%%.*}/${PV}/${CHOST%%-*}-linux/CORE/, which is appended to LDPATH
    # `man 1` are installed with a version

    # -Dfoo = define foo, -Ufoo = undefine foo.

    # This probably needs some further work... but should be okay for
    # now. At least parrot breaks if we don't have -$osname in $archname
    local archname="${CHOST%%-*}-linux"

    # -O3 breaks ext/XS/APItest/t/exception.t and maybe other stuff
    replace-flags -O3 -O2

    cmd=(
        "${WORKBASE}/${PNV}/Configure"
        -des
        -Dcf_by='Exherbo'
        -Dprefix=/usr
        -Dvendorprefix=/usr
        -Dsiteprefix=/usr
        -Doptimize="${CFLAGS}"
        -Darchname="${CHOST%%-*}-linux"
        -Dlibperl="libperl.so.1.${PV}"
        -Dprivlib="/usr/$(get_libdir)/perl5/${PV}"
        -Darchlib="/usr/$(get_libdir)/perl5/${PV}/$archname"
        -Dsitelib="/usr/$(get_libdir)/perl5/site_perl/${PV}"
        -Dsitearch="/usr/$(get_libdir)/perl5/site_perl/${PV}/$archname"
        -Dvendorlib="/usr/$(get_libdir)/perl5/vendor_perl/${PV}"
        -Dvendorarch="/usr/$(get_libdir)/perl5/vendor_perl/${PV}/$archname"
        -Uinstallusrbinperl=
        -Duseshrplib
        -Dmksymlinks
        -Duselargefiles
        -Ui_ndbm
        -$(db_define gdbm)i_gdbm
        -$(db_define berkdb)i_db
        "${PERL5_CONFIGURE_PARAMS[@]}"
    )
    echo sh "${cmd[@]}" >&2
    sh "${cmd[@]}" || die "Configure failed"
}

perl-5_src_test() {
    # This is necessary for the ExtUtils::Embed tests
    echo ln -s libperl.so.1{.${PV},}
    ln -s libperl.so.1{.${PV},}
    echo ln -s libperl.so{.1,}
    ln -s libperl.so{.1,}
    default
}

perl-5_src_install() {
    default

    # Library symlinks
    local perllibdir="/usr/$(get_libdir)/${PN}${PV%%.*}/${PV}/${CHOST%%-*}-linux/CORE/"
    dosym ${perllibdir}/libperl.so.1{.${PV},}
    dosym ${perllibdir}/libperl.so{.1,}

    # We only want /usr/bin/perl5.8.8, not /usr/bin/perl (without the dash, standard across distros)
    # with -Uinstallusrbinperl this shouldn't even get installed, but it does happen anyway, for some reason..
    if [[ -f "${IMAGE}"/usr/bin/${PN} ]]; then
        rm "${IMAGE}"/usr/bin/${PN} || die "Couldn't remove /usr/bin/${PN}"
    fi

    # Version executables
    local executable
    for executable in "${IMAGE}"/usr/bin/*; do
        if egrep -q '^#!/usr/bin/perl( +.*)?$' "${executable}"; then
            sed -i "/^#!\/usr\/bin\/perl/s/perl/perl${PV%-RC*}/" "${executable}" \
                || die "shebang sed failed for ${executable}"
        fi
        if [[ ${executable##*/} != *${PV%-RC*} ]]; then
            mv "${executable}" "${executable}-${PV}" || die "Failed to version ${executable/${IMAGE}}"
        fi
    done

    # Version man1 manpages, discard man3 manpages (use perldoc)
    rm -r "${IMAGE}"/usr/share/man/man3 || die "Couldn't remove man 3 manpages"
    local manpage
    for manpage in "${IMAGE}"/usr/share/man/man1/*.1; do
        mv "${manpage}" "${manpage/%.1/-${PV}.1}" || die "Failed to version ${manpage/${IMAGE}}"
    done

    keepdir /usr/$(get_libdir)/${PN}${PV%%.*}/{site,vendor}_perl/${PV}/${CHOST%%-*}-linux

    insinto /etc/env.d/${PN}
    hereins ${PV} <<EOF
LDPATH="${perllibdir}"
EOF

    # Save a list of what executables & man-pages we're installing
    cd "${IMAGE}"
    local src target alternatives=() Module_Build_pv Module_Build_importance
    exparam -v Module_Build_pv Module_Build_pv
    if [[ -n ${Module_Build_pv} ]]; then
        Module_Build_importance=${Module_Build_pv%.*}
        local decimal=${Module_Build_pv#*.}
        while [[ -n ${decimal} ]]; do
            Module_Build_importance+=.${decimal:0:2}
            decimal=${decimal:2}
        done
    fi

    for src in usr/bin/*${PV} usr/share/man/man1/*${PV}.1; do
        if [[ ${src} == usr/bin/config_data-${PV} ]]; then
            [[ -n ${Module_Build_pv} ]] || die "Module_Build_pv not set"
            mv ${src} usr/bin/config_data-perl-${PV} || die "mv failed"
            alternatives_for config_data ${Module_Build_pv}_perl-${SLOT} ${Module_Build_importance} \
                /usr/bin/config_data config_data-perl-${PV}
        elif [[ ${src} == usr/share/man/man1/config_data-${PV}.1 ]]; then
            [[ -n ${Module_Build_pv} ]] || die "Module_Build_pv not set"
            mv ${src} usr/share/man/man1/config_data-perl-${PV}.1 || die "mv failed"
            alternatives_for config_data ${Module_Build_pv}_perl-${SLOT} ${Module_Build_importance} \
                /usr/share/man/man1/config_data.1 config_data-perl-${PV}.1
        else
            [[ ${src/-${PV}} == ${src} ]] && target=${src/${PV}} || target=${src/-${PV}}
            alternatives+=( /${target} ${src##*/} )
        fi
    done

    # For RCs, this will make sure we get alternatives for usr/bin/perl5.10.1 when PV is 5.10.1-RC1
    if [[ ${PV%-RC*} != ${PV} ]]; then
        for src in usr/bin/*${PV%-RC*}; do
            alternatives+=( /${src/${PV%-RC*}} ${src##*/} )
        done
    fi

    alternatives_for ${PN} ${SLOT} ${SLOT} "${alternatives[@]}"
}


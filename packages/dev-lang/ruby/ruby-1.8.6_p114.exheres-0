# Copyright 2007 Richard Brown
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'ruby-1.8.6_p111.ebuild' from Gentoo, which is:
#     Copyright 1999-2007 Gentoo Foundation

require autotools flag-o-matic multilib versionator

SUMMARY="An object-oriented scripting language"
HOMEPAGE="http://www.ruby-lang.org/"

MY_PNV="${PN}-$(replace_version_separator 3 '-')"
WORK=${WORKBASE}/${MY_PNV}

SLOT=$(get_version_component_range 1-2)
MY_SUFFIX=$(delete_version_separator 1 ${SLOT})

DOWNLOADS="ftp://ftp.ruby-lang.org/pub/ruby/${SLOT}/${MY_PNV}.tar.bz2"

LICENCES="|| ( Ruby GPL-2 )"
PLATFORMS="~amd64 ~x86"
MYOPTIONS="berkdb debug doc examples ipv6 gdbm ssl"

DEPENDENCIES="
    build+run:
        berkdb? ( sys-libs/db:= )
        gdbm? ( sys-libs/gdbm )
        ssl? ( dev-libs/openssl )
"

DEFAULT_SRC_PREPARE_PATCHES=(
    -p2 "${FILES}/${PN}-1.8.6_p111-r13657.patch"
)

src_prepare() {
    sed -i -e "s:\(RUBY_LIB_PREFIX=\"\${prefix}/\)lib:\1$(get_libdir):" \
        configure.in || die "sed failed"

    default
}

src_configure() {
    filter-flags -fomit-frame-pointer

    unset SOCKS_SERVER

    #Yes, this does always --enable-ipv6
    myconf="--enable-ipv6"
    if ! option ipv6; then
        myconf="${myconf} --with-lookup-order-hack=INET"
    fi

    econf --program-suffix=$MY_SUFFIX --enable-shared \
        $(option_enable doc install-doc) \
        $(option_enable debug) \
        $(option_with berkdb dbm) \
        $(option_with gdbm) \
        $(option_with ssl openssl) \
        --disable-socks \
        --disable-threads \
        --without-tk \
        --with-sitedir=/usr/$(get_libdir)/ruby/site_ruby \
        $myconf
}

src_compile() {
    emake EXTLDFLAGS="${LDFLAGS}"
}

src_test() {
    emake -j1 test
}

src_install() {
    unset RUBYOPT
    D_LIBDIR="${IMAGE}/usr/$(get_libdir)"
    LD_LIBRARY_PATH="${D_LIBDIR}"
    RUBYLIB="${WORK}:${D_LIBDIR}/ruby/${SLOT}"

    for dir in $(find "${WORK}/ext" -type d) ; do
        RUBYLIB="${RUBYLIB}:${dir}"
    done

    export LD_LIBRARY_PATH RUBYLIB

    default

    MINIRUBY=$(echo -e 'include Makefile\ngetminiruby:\n\t@echo $(MINIRUBY)'|make -f - getminiruby)
    ${MINIRUBY} -e "p 'Hello world from miniruby.'" || die "miniruby fails to run"
    keepdir $(${MINIRUBY} -rrbconfig -e "print Config::CONFIG['sitelibdir']") \
            $(${MINIRUBY} -rrbconfig -e "print Config::CONFIG['sitearchdir']")

    for i in ruby irb erb testrb rdoc ri; do
        dosym /usr/bin/${i}${MY_SUFFIX} /usr/bin/${i}
    done

    if option doc; then
        emake DESTDIR="${IMAGE}" install-doc
    fi

    if option examples; then
        dodir /usr/share/doc/${PNVR}
        cp -dpPR sample "${IMAGE}/usr/share/doc/${PNVR}"
    fi
}


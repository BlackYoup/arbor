# Copyright 2008, 2009, 2011 Ingmar Vanhassel <ingmar@exherbo.org>
# Copyright 2008 Santiago Mola <coldwind@exherbo.org>
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'tcl-8.5.3.ebuild' from Gentoo, which is:
#     Copyright 1999-2008 Gentoo Foundation.

require autotools [ supported_autoconf=[ 2.5 ] supported_automake=[ 1.11 1.10 ] ]
require sourceforge [ suffix=tar.gz pnv=${PN}${PV}-src ]

MY_PNV="${PN}${PV}"

SUMMARY="Tool Command Language"
DESCRIPTION="
Tcl (Tool Command Language) is a very powerful but easy to learn dynamic
programming language, suitable for a very wide range of uses, including web and
desktop applications, networking, administration, testing and many more. Open
source and business-friendly, Tcl is a mature yet evolving language that is
truly cross platform, easily deployed and highly extensible.
"
HOMEPAGE="http://www.tcl.tk/"

REMOTE_IDS+=" freshmeat:tcltk"

LICENCES="BSD-3"
SLOT="0"
PLATFORMS="~amd64 ~arm ~ppc64 ~x86"
MYOPTIONS="debug"

DEPENDENCIES=""

WORK="${WORKBASE}/${MY_PNV}/unix"

RESTRICT="test"

DEFAULT_SRC_PREPARE_PATCHES=(
    -p2 "${FILES}/${PN}-multilib.patch"
        "${FILES}/${PN}-tclm4-soname.patch"
)
DEFAULT_SRC_CONFIGURE_OPTION_ENABLES=( "debug symbols" )
DEFAULT_SRC_CONFIGURE_PARAMS=( --enable-threads )

src_install() {
    default
    nonfatal emake DESTDIR="${IMAGE}" install-private-headers || die "emake install-private-headers failed"

    keepdir /usr/${LIBDIR}/${PN}8/8.3/

    local v1=$(ever range 1-2)
    dosym /usr/bin/tclsh{${v1},}

    # Fix the tclConfig.sh to eliminate references to the build directory
    local mylibdir=${LIBDIR} ; mylibdir=${mylibdir//\/}
    edo sed -e "s,^TCL_BUILD_LIB_SPEC='-L.*/unix,TCL_BUILD_LIB_SPEC='-L$/usr/${mylibdir}," \
            -e "s,^TCL_SRC_DIR='.*',TCL_SRC_DIR='/usr/${mylibdir}/${PN}${v1}/include'," \
            -e "s,^TCL_BUILD_STUB_LIB_SPEC='-L.*/unix,TCL_BUILD_STUB_LIB_SPEC='-L/usr/${mylibdir}," \
            -e "s,^TCL_BUILD_STUB_LIB_PATH='.*/unix,TCL_BUILD_STUB_LIB_PATH='/usr/${mylibdir}," \
            -e "s,^TCL_LIB_FILE='libtcl${v1}..TCL_DBGX..so',TCL_LIB_FILE=\"libtcl${v1}\$\{TCL_DBGX\}.so\"," \
            -e "s,^TCL_CC_SEARCH_FLAGS='\(.*\)',TCL_CC_SEARCH_FLAGS='\1:/usr/${mylibdir}'," \
            -e "s,^TCL_LD_SEARCH_FLAGS='\(.*\)',TCL_LD_SEARCH_FLAGS='\1:/usr/${mylibdir}'," \
            -i "${IMAGE}"/usr/${mylibdir}/tclConfig.sh

    dodoc "${WORKBASE}"/${MY_PNV}/{ChangeLog*,changes,README}
}


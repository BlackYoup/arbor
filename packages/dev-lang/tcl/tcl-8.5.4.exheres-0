# Copyright 2008 Ingmar Vanhassel <ingmar@exherbo.org>
# Copyright 2008 Santiago Mola <coldwind@exherbo.org>
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'tcl-8.5.3.ebuild' from Gentoo, which is:
#     Copyright 1999-2008 Gentoo Foundation.

SUPPORTED_AUTOCONF=( 2.5 )
SUPPORTED_AUTOMAKE=( 1.10 )

require common-metadata multilib autotools versionator

MY_PNV="${PN}${PV}"

DOWNLOADS="mirror://sourceforge/${PN}/${MY_PNV}-src.tar.gz"

SLOT="0"
PLATFORMS="~amd64"
MYOPTIONS="debug threads"

DEPENDENCIES=""

WORK="${WORKBASE}/${MY_PNV}/unix"

DEFAULT_SRC_PREPARE_PATCHES=(
    -p2 "${FILES}/${PN}-multilib.patch"
    "${FILES}/${PN}-tclm4-soname.patch"
)
DEFAULT_SRC_CONFIGURE_OPTION_ENABLES=( "debug symbols" threads )

src_install() {
    default
    nonfatal emake DESTDIR="${IMAGE}" install-private-headers || die "emake install-private-headers failed"

    keepdir /usr/$(get_libdir)/${PN}8/8.3/

    local v1=$(get_version_component_range 1-2)
    dosym /usr/bin/tclsh{${v1},}

    # Fix the tclConfig.sh to eliminate references to the build directory
    local mylibdir=$(get_libdir) ; mylibdir=${mylibdir//\/}
    sed -e "s,^TCL_BUILD_LIB_SPEC='-L.*/unix,TCL_BUILD_LIB_SPEC='-L$/usr/${mylibdir}," \
        -e "s,^TCL_SRC_DIR='.*',TCL_SRC_DIR='/usr/${mylibdir}/tcl${v1}/include'," \
        -e "s,^TCL_BUILD_STUB_LIB_SPEC='-L.*/unix,TCL_BUILD_STUB_LIB_SPEC='-L/usr/${mylibdir}," \
        -e "s,^TCL_BUILD_STUB_LIB_PATH='.*/unix,TCL_BUILD_STUB_LIB_PATH='/usr/${mylibdir}," \
        -e "s,^TCL_LIB_FILE='libtcl${v1}..TCL_DBGX..so',TCL_LIB_FILE=\"libtcl${v1}\$\{TCL_DBGX\}.so\"," \
        -e "s,^TCL_CC_SEARCH_FLAGS='\(.*\)',TCL_CC_SEARCH_FLAGS='\1:/usr/${mylibdir}'," \
        -e "s,^TCL_LD_SEARCH_FLAGS='\(.*\)',TCL_LD_SEARCH_FLAGS='\1:/usr/${mylibdir}'," \
        -i "${IMAGE}"/usr/${mylibdir}/tclConfig.sh || die

    dodoc "${WORKBASE}"/${MY_PNV}/{ChangeLog*,changes,README}
}


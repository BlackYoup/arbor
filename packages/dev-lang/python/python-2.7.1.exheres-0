# Copyright 2010 Paul Seidler
# Distributed under the terms of the GNU General Public License v2

require python-build

PLATFORMS="~amd64 ~ppc64"

DEPENDENCIES+="
    build:
        sys-devel/autoconf[>=2.65]
    build+run:
        dev-libs/expat
"

DEFAULT_SRC_CONFIGURE_PARAMS+=( '--with-system-expat' )

src_prepare() {
    # support autoconf versions other than 2.65
    edo sed -ie '8,14d' "${WORK}"/configure.in

    python-build_src_prepare

    # replace still to be done libdir variables
    edo sed -ie "s:@@EXHERBO_LIBDIR@@:$(get_libdir):g" \
        Lib/sysconfig.py \
        Lib/test/test_site.py
}

src_test() {
    # for test_ssl
    esandbox allow_net --connect "inet:127.0.0.1@0"

    # needed for test_socket
    esandbox allow_net --connect "inet:127.0.0.1@80"
    esandbox allow_net --connect "inet6:::1@80"
    esandbox allow_net "unix-abstract:python-test-hello"
    esandbox allow_net "unix-abstract:hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh"

    python-build_src_test

    esandbox disallow_net --connect "inet:127.0.0.1@0"
}

src_install() {
    python-build_src_install

    # remove empty directory
    edo rmdir "${IMAGE}"/usr/$(get_libdir)/${PN}${SLOT}/lib-old
}


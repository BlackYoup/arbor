# Copyright 2007-2007 Bryan Ã˜stergaard
# Copyright 2008 Ali Polatel
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'python-2.5.2-r4.ebuild' from Gentoo, which is:
#  Copyright 1999-2008 Gentoo Foundation

require flag-o-matic multilib toolchain-funcs autotools [ supported_autoconf=[ 2.5 ] supported_automake=[ 1.10 ] ] python

MY_PNV="Python-${PV}"
WORK="${WORKBASE}/${MY_PNV}"

SUMMARY="Python interpreter"
HOMEPAGE="http://www.python.org"
DOWNLOADS="http://python.org/ftp/python/${PV}/${MY_PNV}.tar.bz2
    http://dev.exherbo.org/~ingmar/distfiles/${PN}-exherbo-patches-${PV}-r1.tar.bz2"

LICENCES="PSF-2.2"
SLOT="2.6"
PLATFORMS="~amd64 ~ia64 ~ppc64 ~x86"
MYOPTIONS="berkdb gdbm examples ipv6 ncurses readline sqlite ssl tk"

DEPENDENCIES="
build+run:
    dev-libs/expat
    >=sys-libs/zlib-1.1.3
    berkdb? ( >=sys-libs/db-3.1:= )
    gdbm? ( sys-libs/gdbm )
    ncurses? (
        >=sys-libs/ncurses-5.2
        readline? ( >=sys-libs/readline-4.1 )
        )
    sqlite? ( >=dev-db/sqlite-3 )
    ssl? ( dev-libs/openssl )
    tk? ( >=dev-lang/tk-8.0 )"

DEFAULT_SRC_PREPARE_PATCHES=( "${WORKBASE}/${PV}/" )

src_prepare() {
    default

    sed -i -e "s:@@EXHERBO_LIBDIR@@:$(get_libdir):g" \
        Lib/distutils/command/install.py \
        Lib/distutils/sysconfig.py \
        Lib/site.py \
        Makefile.pre.in \
        Modules/Setup.dist \
        Modules/getpath.c \
        setup.py || die "sed failed to replace EXHERBO_LIBDIR"

    eautoreconf
}

DEFAULT_SRC_CONFIGURE_PARAMS=( --enable-shared --enable-unicode=ucs4 )
DEFAULT_SRC_CONFIGURE_OPTION_ENABLES=( ipv6 )

src_configure() {
    # dbm module can link to berkdb or gdbm.
    # default to gdbm when both are enabled.
    local disable
    option berkdb   || option gdbm || disable="${disable} dbm"
    option berkdb   || disable="${disable} bsddb"
    option gdbm     || disable="${disable} gdbm"
    option ncurses  || disable="${disable} _curses _curses_panel"
    option readline || disable="${disable} readline"
    option sqlite   || disable="${disable} _sqlite3"
    option ssl      || export PYTHON_DISABLE_SSL=1
    option tk       || disable="${disable} _tkinter"
    export PYTHON_DISABLE_MODULES="${disable}"

    # Gentoo #228905
    if [[ "$(gcc-major-version)" -ge 4 ]] ; then
        append-flags "-fwrapv"
    fi

    export OPT="${CFLAGS}"

    # export CXX so it ends up in /usr/lib/python2.x/config/Makefile
    tc-export CXX

    default
}

src_install() {
    default

    # Installs empty directory.
    rmdir "${IMAGE}"/usr/$(get_libdir)/${PN}${SLOT}/lib-old
}

src_test() {
    python_enable_pyc

    # rerun failed tests in verbose mode (regrtest -w)
    EXTRATESTOPTS="-w" emake test
}

pkg_postinst() {
    python_version

    python_mod_optimize
    python_mod_optimize -x site-packages \
                        -x test /usr/$(get_libdir)/python${PYVER}
}

pkg_postrm() {
    python_version
    python_mod_cleanup /usr/$(get_libdir)/python${PYVER}
}

# Copyright 2011 Michael Thomas <aelmalinka@gmail.com>
# Distributed under the terms of the GNU General Public Licesnse v2

MY_PV="v${PV}"
MY_PNV="${PN}-${MY_PV}"
WORK="${WORKBASE}/${MY_PNV}"

SUMMARY="Evented I/O for V8 Javascript"
DESCRIPTION="Designed to provide an easy way to build scalable network applications, similar to Event Machine or Twisted"
DOWNLOADS="http://nodejs.org/dist/${MY_PV}/${MY_PNV}.tar.gz"
HOMEPAGE="http://nodejs.org/"
LICENCES="MIT"
SLOT="0"
PLATFORMS="~amd64 ~x86"
MYOPTIONS="
    npm [[ description = [ install bundled npm module ] ]]
    waf
"

DEPENDENCIES="
    build:
        dev-lang/python:*[<3.0]
    build+run:
        dev-libs/libpthread-stubs
        dev-libs/openssl
        sys-libs/zlib
    npm? ( run: !dev-node/npm )
"

SRC_CONFIGURE_PARAMS=(
    --prefix=/usr
    --shared-openssl
    --shared-zlib
)

DEFAULT_SRC_COMPILE_PARAMS=(
    V=1
)

DEFAULT_SRC_CONFIGURE_OPTION_WITHS=( "waf" )

LD="${CXX}"

RESTRICT="test"

src_prepare() {
    default
    edo sed -i -e 's:#!/usr/bin/env python:#!/usr/bin/env python2:' configure
}

src_configure() {
    if ! option npm; then
        SRC_CONFIGURE_PARAMS+=( --without-npm )
    fi

    edo ./configure "${SRC_CONFIGURE_PARAMS[@]}"
}

src_install() {
    default

    option npm && \
        [[ $LIBDIR != lib ]] && \
        edo mv "${IMAGE}/usr/lib" "${IMAGE}/usr/${LIBDIR}"
}

src_test() {
    # rebuild certificates, using updated parameters from ef046bf4f64161c6d0f4c4920ab62895789d576c.patch
    emake -j1 -C test/fixtures/keys clean
    emake -j1 -C test/fixtures/keys

    esandbox allow_net "inet:0.0.0.0@0"
    esandbox allow_net "inet:0.0.0.0@12346"
    esandbox allow_net "unix:${WORK}/test/tmp/test.sock"

    emake test
}


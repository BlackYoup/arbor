# Copyright 2011 Michael Thomas <aelmalinka@gmail.com>
# Distributed under the terms of the GNU General Public Licesnse v2

MY_PV="v${PV}"
MY_PNV="${PN}-${MY_PV}"
WORK="${WORKBASE}/${MY_PNV}"

SUMMARY="Evented I/O for V8 Javascript"
DESCRIPTION="Designed to provide an easy way to build scalable network applications, similar to Event Machine or Twisted"
DOWNLOADS="http://nodejs.org/dist/${MY_PV}/${MY_PNV}.tar.gz"
HOMEPAGE="http://nodejs.org/"
LICENCES="MIT"

require waf [ waf_executable="./tools/waf-light" ]

export_exlib_phases src_prepare src_test src_install

DEPENDENCIES="
    build+run:
        dev-libs/libpthread-stubs
        dev-libs/openssl
        dev-libs/v8
"

DEFAULT_SRC_PREPARE_PATCHES=(
    -p1 "${FILES}/test-avoid-binding-to-0.0.0.0.patch"
    -p1 "${FILES}/test-pingpong-avoid-binding-to-0.0.0.0.patch"
)

WAF_SRC_CONFIGURE_PARAMS=(
    --shared-v8
    --hates=bindir
    --hates=htmldir
    --hates=datadir
)

node_src_prepare() {
    default

    if ! ever at_least 0.7.7 ; then
        expatch -p1 "${FILES}/ef046bf4f64161c6d0f4c4920ab62895789d576c.patch"
        expatch -p1 "${FILES}/allow-rebuilding-keys-without-interaction.patch"
    fi

    # these tests fail on localhost
    edo mv test/simple/test-dgram-{broad,multi}cast-multi-process.js test/disabled
    # these tests call out to openssl which will only bind on 0.0.0.0
    edo mv test/simple/test-tls-securepair-{client,server}.js test/simple/test-tls-ext-key-usage.js test/disabled
    # these tests call out to google.com
    edo mv test/simple/test-net-connect-timeout.js test/simple/test-regress-GH-819.js test/disabled
}

node_src_install() {
    waf_src_install

    edo rmdir "${IMAGE}/usr/include/node/ev"
    edo rm -r "${IMAGE}/usr/${LIBDIR}/node_modules/npm/man"

    doman $(find deps/npm/man -type f)
}

node_src_test() {
    # rebuild certificates, using updated parameters from ef046bf4f64161c6d0f4c4920ab62895789d576c.patch
    emake -j1 -C test/fixtures/keys clean
    emake -j1 -C test/fixtures/keys

    esandbox allow_net "inet:0.0.0.0@0"
    esandbox allow_net "unix:${WORK}/test/tmp/test.sock"

    PATH="${WORK}:${PATH}" emake -j1 test
}

# Copyright 2011 Michael Thomas <aelmalinka@gmail.com>
# Distributed under the terms of the GNU General Public Licesnse v2

require cmake

export_exlib_phases src_configure src_test

MY_PNV="${PN}-v${PV}"
WORK="${WORKBASE}/${MY_PNV}"

SUMMARY="Evented I/O for V8 Javascript"
DESCRIPTION="Desgined to provide an easy way to build scalable network applications, similar to Event Machine or Twisted"
DOWNLOADS="http://nodejs.org/dist/${MY_PNV}.tar.gz"
HOMEPAGE="http://nodejs.org/"
LICENCES="MIT"

DEPENDENCIES="
    build+run:
        dev-libs/libev
        dev-libs/libpthread-stubs
        dev-libs/openssl
        dev-libs/v8
        net-dns/c-ares
"

DEFAULT_SRC_PREPARE_PATCHES=(
    "${FILES}/fix-build.patch"
)

CMAKE_SRC_CONFIGURE_PARAMS+=(
    -DSHARED_CARES:BOOL=True
    -DSHARED_LIBEV:BOOL=True
    -DSHARED_V8:BOOL=True
)

node_src_configure() {
    cmake_src_configure

    # tools/js2cs.py assumes that jsmin is in ../deps/v8/tools
    edo mkdir -p "${WORKBASE}/build/deps/v8/tools"
    edo ln -s "${WORK}/deps/v8/tools/jsmin.py" "${WORKBASE}/build/deps/v8/tools"
}

node_src_test() {
    # TODO: ctest test-suite makes invalid assumptions about directory layout
    :
}

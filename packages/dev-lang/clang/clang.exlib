# Copyright 2012 Elias Pipping <pipping@exherbo.org>
# Distributed under the terms of the GNU General Public License v2

require cmake [ api=2 ] easy-multibuild

SUMMARY="C language family frontend for LLVM"
HOMEPAGE="http://clang.llvm.org/"

LICENCES="UoI-NCSA"
SLOT="0"
MYOPTIONS="multibuild_c: 32 64"

DEPENDENCIES="
    build:
        dev-lang/perl:*
        sys-devel/flex
    build+run:
        dev-lang/llvm[~${PV}]
    run:
       sys-devel/gcc:*
"

DEFAULT_SRC_PREPARE_PATCHES=( "${FILES}"/${PN}-3.2-tblgen.patch )

src_prepare() {
    edo pushd "${CMAKE_SOURCE}"

    # Fix the use of dot
    edo sed -e 's/@DOT@//g' -i docs/doxygen.cfg.in
    default

    edo popd
}

configure_one_multibuild() {
    local args=(
        -DCLANG_PATH_TO_LLVM_BUILD:STRING=/usr
        -DLLVM_LIBDIR_SUFFIX:STRING=${LIBDIR#lib}
    )
    ecmake "${args[@]}"
}

test_one_multibuild() {
    PATH=/usr/libexec/llvm:${PWD}/utils/TableGen/clang_tblgen_build_subdir:$PATH CLANG=${PWD}/bin/clang emake clang-test
}

src_install() {
    easy-multibuild_src_install

    # the sole file here, config.h, is explicitly not installed
    edo rmdir "${IMAGE}"/usr/include/clang/Config

    edo pushd "${CMAKE_SOURCE}"/tools
    insinto /usr/share/clang-analyzer
    for f in scan-{build,view} ; do
        doins -r ${f}
        dosym /usr/share/clang-analyzer/${f}/${f} /usr/bin/${f}
    done
    edo popd
    edo pushd "${IMAGE}"/usr/share/clang-analyzer
    edo chmod a+x scan-build/{ccc-analyzer,scan-build,set-xcode-analyzer} scan-view/scan-view
    edo popd
}


# Copyright 2008, 2009, 2010, 2011 Ingmar Vanhassel <ingmar@exherbo.org>
# Distributed under the terms of the GNU General Public License v2

require toolchain-funcs flag-o-matic

export_exlib_phases pkg_setup src_prepare src_configure src_test src_install

myexparam -b snapshot=false

SUMMARY="Low Level Virtual Machine (LLVM)"
DESCRIPTION="
Low-Level Virtual Machine (LLVM) is a compiler infrastructure designed for
compile-time, link-time, run-time, and 'idle-time' optimization of programs
from arbitrary programming languages. It currently supports compilation of C,
Objective-C, and C++ programs, using front-ends derived from GCC 4.0, GCC 4.2,
and a custom new front-end, 'clang'. It supports x86, x86_64, ia64, PowerPC,
and SPARC, with support for Alpha and ARM under development.

Some of the goals of clang include the following:
- End-User Features
  Fast compiles and low memory use
  Expressive diagnostics (examples)
  GCC compatibility
- Utility and Applications
  Modular library based architecture
  Support diverse clients (refactoring, static analysis, code generation, etc)
  Allow tight integration with IDEs
  Use the LLVM 'BSD' License
- Internal Design and Implementation
  A real-world, production quality compiler
  A simple and hackable code base
  A single unified parser for C, Objective C, C++, and Objective C++
  Conformance with C/C++/ObjC and their variants
"
HOMEPAGE="http://llvm.org/"
DOWNLOADS="
    ${HOMEPAGE}/releases/${PV}/${PNV}.tgz
    clang? ( ${HOMEPAGE}/releases/${PV}/clang-${PV}.tgz )
"

ADMISSIBLE_GCC_VERSIONS=( 4.4.5 4.4.6 4.5.2 4.5.3 )

LICENCES="UoI-NCSA"
SLOT="0"
MYOPTIONS="
    clang gold
    gcc_version: ( ${ADMISSIBLE_GCC_VERSIONS[@]} ) [[ number-selected = exactly-one ]]
"

if ! ever is_scm && ! exparam -b snapshot; then
    MYOPTIONS="( ${MYOPTIONS} ) doc"
fi

DEPENDENCIES="
    build:
        dev-lang/perl:*
        sys-devel/flex
    build+run:
        gold? ( sys-devel/binutils[>=2.21][gold(+)] )
    test:
        dev-lang/python:*
"

for GCC_VERSION in ${ADMISSIBLE_GCC_VERSIONS[@]}; do
    DEPENDENCIES+="
        build+run: gcc_version:${GCC_VERSION}? ( sys-devel/gcc[~${GCC_VERSION}] )
    "
done

if ! ever is_scm && ! exparam -b snapshot; then
    DEPENDENCIES+="
    build:
        doc? (
            app-doc/doxygen
            media-gfx/graphviz
        )
"
fi

BUGS_TO="ingmar@exherbo.org"

REMOTE_IDS="freshmeat:${PN}"

UPSTREAM_DOCUMENTATION="http://llvm.org/docs [[ lang = en ]]"
UPSTREAM_RELEASE_NOTES="${HOMEPAGE}/releases/${PV}/docs/ReleaseNotes.html"

DEFAULT_SRC_COMPILE_PARAMS=( VERBOSE=1 )

get_gcc_version() {
    local gcc_version
    for gcc_version in ${ADMISSIBLE_GCC_VERSIONS[@]}; do
        if option gcc_version:${gcc_version}; then
            echo ${gcc_version}
            return;
        fi
    done
    die "No gcc_version option set"
}

cxx_is_gxx() {
    [[ ${CXX} == *g++* ]] && [[ ${CXX} != *clang* ]]
}

llvm_pkg_setup() {
    if cxx_is_gxx; then
        local gxx_version=$(gxx-major-version).$(gxx-minor-version)
        if ever at_least 4.5 ${gxx_version}; then
            # gcc 4.5 miscompiles clang at -O2 and above
            append-flags -O1
        fi
    fi
}

llvm_src_prepare() {
    expatch "${FILES}"/0001-Respect-variables-set-by-configure.patch
    if option clang; then
        ever is_scm || exparam -b snapshot || edo mv "${WORKBASE}/clang-${PV}" "${WORK}/tools/clang"
        edo pushd tools/clang
        edo sed \
            -e "/Exherbo/{N;N;N;s/4\.4\.3/$(get_gcc_version)/g}" \
            -i lib/Frontend/InitHeaderSearch.cpp
        expatch "${FILES}"/0001-Replace-PROJ_prefix-lib-with-PROJ_libdir.patch
        edo popd
    fi
    default
}

llvm_src_configure() {
    local enable_docs=
    ever is_scm || exparam -b snapshot || enable_docs=$(option_enable doc doxygen)
    econf \
        --enable-shared \
        --enable-optimized \
        --with-cxx-include-arch="${CHOST}" \
        --with-cxx-include-root="/usr/include/c++/$(get_gcc_version)/" \
        $(option_with clang built-clang) \
        $(option gold && echo --with-binutils-include=/usr/include) \
        ${enable_docs}
}

llvm_src_test() {
    local lit_args="-v -j${EXJOBS:-1}"
    emake check LIT_ARGS="${lit_args}"
    option clang && emake test -C tools/clang LIT_ARGS="${lit_args}"
}

llvm_src_install() {
    emake install \
        DESTDIR="${IMAGE}" \
        KEEP_SYMBOLS=1 \
        VERBOSE=1

    if option gold ; then
        # Make sure nm and ar find the gold plugin
        dodir /usr/${CHOST}/lib/bfd-plugins
        dosym /usr/${LIBDIR}/LLVMgold.so /usr/${CHOST}/lib/bfd-plugins
    fi
}


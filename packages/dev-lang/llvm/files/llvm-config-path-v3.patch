Source: written by Johannes Nixdorf, updated by Arne Janbu
Upstream: No, see http://llvm.org/bugs/show_bug.cgi?id=9136
Reason: Without this patch, llvm-config returns a wrong path with multilib

From 096027b9612040b5cf515cb23b83c3d177a9b794 Mon Sep 17 00:00:00 2001
From: Johannes Nixdorf <mixi@exherbo.org>
Date: Sat, 9 Mar 2013 22:39:26 +0100
Subject: [PATCH 2/2] llvm-config: don't use the executable path if not in a
 development tree

There is no reason to use the current path to guess the library install
dir if it is not in a development tree.

This behaviour broke LLVM_LIBDIR_SUFFIX when using cmake and --libdir,
--bindir and --includedir when using autotools.

With this change moving llvm-config to a different location (used by us
to support 32bit and 64bit libraries on the same file system) is also
supported as long as the new location doesn't look like a development
tree.

Arne Janbu: Added the re-inclusion of LLVM_LIBDIR. It was removed
upsteam and we need it to specify /usr/lib{32,64}.
---
 CMakeLists.txt                          | 6 ++++++
 autoconf/configure.ac                   | 6 +++++-
 cmake/config-ix.cmake                   | 2 --
 configure                               | 8 +++++++-
 include/llvm/Config/llvm-config.h.cmake | 3 +++
 include/llvm/Config/llvm-config.h.in    | 3 +++
 tools/llvm-config/llvm-config.cpp       | 8 ++++----
 7 files changed, 28 insertions(+), 8 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 36e6ed8..42330b7 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -126,6 +126,12 @@ set(LLVM_EXAMPLES_BINARY_DIR ${LLVM_BINARY_DIR}/examples)
 set(LLVM_INCLUDE_DIR ${CMAKE_CURRENT_BINARY_DIR}/include)
 set(LLVM_LIBDIR_SUFFIX "" CACHE STRING "Define suffix of library directory name (32/64)" )
 
+# set LLVM_*DIR for include/llvm/Config/llvm-config.h
+set(LLVM_PREFIX ${CMAKE_INSTALL_PREFIX})
+set(LLVM_LIBDIR ${LLVM_PREFIX}/lib${LLVM_LIBDIR_SUFFIX})
+set(LLVM_INCLUDEDIR ${LLVM_PREFIX}/include)
+set(LLVM_BINDIR ${LLVM_PREFIX}/bin)
+
 set(LLVM_ALL_TARGETS
   AArch64
   ARM
diff --git a/autoconf/configure.ac b/autoconf/configure.ac
index a1c2ac5..7557dd0 100644
--- a/autoconf/configure.ac
+++ b/autoconf/configure.ac
@@ -1860,6 +1860,7 @@ if test "${prefix}" = "NONE" ; then
 fi
 eval LLVM_PREFIX="${prefix}";
 eval LLVM_BINDIR="${prefix}/bin";
+eval LLVM_LIBDIR="${prefix}/lib";
 eval LLVM_DATADIR="${prefix}/share/llvm";
 eval LLVM_DOCSDIR="${prefix}/share/doc/llvm";
 eval LLVM_ETCDIR="${prefix}/etc/llvm";
@@ -1869,6 +1870,7 @@ eval LLVM_MANDIR="${prefix}/man";
 LLVM_CONFIGTIME=`date`
 AC_SUBST(LLVM_PREFIX)
 AC_SUBST(LLVM_BINDIR)
+AC_SUBST(LLVM_LIBDIR)
 AC_SUBST(LLVM_DATADIR)
 AC_SUBST(LLVM_DOCSDIR)
 AC_SUBST(LLVM_ETCDIR)
@@ -1888,6 +1890,8 @@ AC_DEFINE_UNQUOTED(LLVM_PREFIX,"$LLVM_PREFIX",
                    [Installation prefix directory])
 AC_DEFINE_UNQUOTED(LLVM_BINDIR, "$LLVM_BINDIR",
                    [Installation directory for binary executables])
+AC_DEFINE_UNQUOTED(LLVM_LIBDIR, "$LLVM_LIBDIR",
+                   [Installation directory for libraries])
 AC_DEFINE_UNQUOTED(LLVM_DATADIR, "$LLVM_DATADIR",
                    [Installation directory for data files])
 AC_DEFINE_UNQUOTED(LLVM_DOCSDIR, "$LLVM_DOCSDIR",
@@ -1947,7 +1951,7 @@ for a_binding in $BINDINGS_TO_BUILD ; do
         AC_SUBST(OCAML_LIBDIR,$ocaml_stdlib)
       else
         # ocaml stdlib is outside our prefix; use libdir/ocaml
-        AC_SUBST(OCAML_LIBDIR,${prefix}/lib/ocaml)
+        AC_SUBST(OCAML_LIBDIR,$LLVM_LIBDIR/ocaml)
       fi
     fi
     ;;
diff --git a/cmake/config-ix.cmake b/cmake/config-ix.cmake
index b862ceb..d109054 100755
--- a/cmake/config-ix.cmake
+++ b/cmake/config-ix.cmake
@@ -457,8 +457,6 @@ if (LLVM_ENABLE_ZLIB )
   endif()
 endif()
 
-set(LLVM_PREFIX ${CMAKE_INSTALL_PREFIX})
-
 if (LLVM_ENABLE_DOXYGEN)
   message(STATUS "Doxygen enabled.")
   find_package(Doxygen REQUIRED)
diff --git a/configure b/configure
index e9aba06..0ce9ac2 100755
--- a/configure
+++ b/configure
@@ -790,6 +790,7 @@ MMAP_FILE
 SHLIBEXT
 LLVM_PREFIX
 LLVM_BINDIR
+LLVM_LIBDIR
 LLVM_DATADIR
 LLVM_DOCSDIR
 LLVM_ETCDIR
@@ -19154,6 +19155,7 @@ if test "${prefix}" = "NONE" ; then
 fi
 eval LLVM_PREFIX="${prefix}";
 eval LLVM_BINDIR="${prefix}/bin";
+eval LLVM_LIBDIR="${prefix}/lib";
 eval LLVM_DATADIR="${prefix}/share/llvm";
 eval LLVM_DOCSDIR="${prefix}/share/doc/llvm";
 eval LLVM_ETCDIR="${prefix}/etc/llvm";
@@ -19185,6 +19187,9 @@ cat >>confdefs.h <<_ACEOF
 #define LLVM_BINDIR "$LLVM_BINDIR"
 _ACEOF
 
+cat >>confdefs.h <<_ACEOF
+#define LLVM_LIBDIR "$LLVM_LIBDIR"
+_ACEOF
 
 cat >>confdefs.h <<_ACEOF
 #define LLVM_DATADIR "$LLVM_DATADIR"
@@ -19273,7 +19278,7 @@ echo "$as_me: WARNING: --enable-bindings=ocaml specified, but ocamlopt not found
 
       else
         # ocaml stdlib is outside our prefix; use libdir/ocaml
-        OCAML_LIBDIR=${prefix}/lib/ocaml
+        OCAML_LIBDIRi=$LLVM_LIBDIR/ocaml
 
       fi
     fi
@@ -20343,6 +20348,7 @@ MMAP_FILE!$MMAP_FILE$ac_delim
 SHLIBEXT!$SHLIBEXT$ac_delim
 LLVM_PREFIX!$LLVM_PREFIX$ac_delim
 LLVM_BINDIR!$LLVM_BINDIR$ac_delim
+LLVM_LIBDIR!$LLVM_LIBDIR$ac_delim
 LLVM_DATADIR!$LLVM_DATADIR$ac_delim
 LLVM_DOCSDIR!$LLVM_DOCSDIR$ac_delim
 LLVM_ETCDIR!$LLVM_ETCDIR$ac_delim
diff --git a/include/llvm/Config/llvm-config.h.cmake b/include/llvm/Config/llvm-config.h.cmake
index 5811164..023e7ba 100644
--- a/include/llvm/Config/llvm-config.h.cmake
+++ b/include/llvm/Config/llvm-config.h.cmake
@@ -47,6 +47,9 @@
 /* Installation directory for .info files */
 #cmakedefine LLVM_INFODIR "${LLVM_INFODIR}"
 
+/* Installation directory for libraries */
+#cmakedefine LLVM_LIBDIR "${LLVM_LIBDIR}"
+
 /* Installation directory for man pages */
 #cmakedefine LLVM_MANDIR "${LLVM_MANDIR}"
 
diff --git a/include/llvm/Config/llvm-config.h.in b/include/llvm/Config/llvm-config.h.in
index 5656240..948f925 100644
--- a/include/llvm/Config/llvm-config.h.in
+++ b/include/llvm/Config/llvm-config.h.in
@@ -47,6 +47,9 @@
 /* Installation directory for .info files */
 #undef LLVM_INFODIR
 
+/* Installation directory for libraries */
+#undef LLVM_LIBDIR
+
 /* Installation directory for man pages */
 #undef LLVM_MANDIR
 
diff --git a/tools/llvm-config/llvm-config.cpp b/tools/llvm-config/llvm-config.cpp
index ed1c8c3..2948b79 100644
--- a/tools/llvm-config/llvm-config.cpp
+++ b/tools/llvm-config/llvm-config.cpp
@@ -260,10 +260,10 @@ int main(int argc, char **argv) {
     ActiveIncludeOption = ("-I" + ActiveIncludeDir + " " +
                            "-I" + ActiveObjRoot + "/include");
   } else {
-    ActivePrefix = CurrentExecPrefix;
-    ActiveIncludeDir = ActivePrefix + "/include";
-    ActiveBinDir = ActivePrefix + "/bin";
-    ActiveLibDir = ActivePrefix + "/lib";
+    ActivePrefix = LLVM_PREFIX;
+    ActiveIncludeDir = LLVM_INCLUDEDIR;
+    ActiveBinDir = LLVM_BINDIR;
+    ActiveLibDir = LLVM_LIBDIR;
     ActiveIncludeOption = "-I" + ActiveIncludeDir;
   }
 
-- 
2.0.0


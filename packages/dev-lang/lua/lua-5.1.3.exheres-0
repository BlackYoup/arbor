# Copyright 2008 Ingmar Vanhassel <ingmar@exherbo.org>
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'lua-5.1.3.ebuild' from Gentoo, which is:
#     Copyright 1999-2008 Gentoo Foundation.

require multilib versionator

SUMMARY="An Extensible Extension Language"
HOMEPAGE="http://www.lua.org/"
SRC_URI="http://www.lua.org/ftp/${P}.tar.gz"

LICENSE="MIT"
SLOT="0"
PLATFORMS="~amd64"
MYOPTIONS=""

DEPENDENCIES=""

# FIXME: Build a lua shared library, keeping the lua interpreter statically linked for performance reasons:
#   http://article.gmane.org/gmane.comp.lang.lua.general/18519
#   This is not done upstream for portability.

DEFAULT_SRC_PREPARE_PATCHES=( "${FILESDIR}"/${PF#${PN}-}/ )

src_prepare() {
    # Doing this here instead of passing relevant options in src_{compile,install} is cleaner
    # Set install paths, don't create empty directories.
    sed -e "/^INSTALL_TOP/s:= .*:= ${D}/usr:" \
        -e "/^INSTALL/s:lib:$(get_libdir):" \
        -e '/MKDIR/s:$(INSTALL_LMOD) $(INSTALL_CMOD)::' \
        -i Makefile || die "sedding Makefile failed"
    sed -e "/^prefix/s:/.*$:/usr:" \
        -e "s:/lib:/$(get_libdir):" \
        -i etc/${PN}.pc || die "sedding etc/${PN}.pc failed"

    default
}

src_compile() {
    # Using dlopen is recommended, see INSTALL.
    # The echo target outputs some debug info.
    emake \
        CC=$(tc-getCC) \
        CFLAGS="-DLUA_USE_DLOPEN ${CFLAGS}" \
        MYLDFLAGS="${LDFLAGS}" \
        MYLIBS="-ldl" \
        PLAT="linux" \
        echo all
}

src_test() {
    default

    # Run lua test scripts
    # Skipped, because they're interactive: globals luac table xd
    tests="bisect cf echo env factorial fibfor fib hello life printf readonly sieve sort trace-calls trace-globals"
    for t in ${tests}; do
        echo "./src/lua test/${t}.lua"
        case ${t} in
            readonly)
                ./src/lua test/${t}.lua && die "Test ./src/lua test/${t}.lua failed" ;;
            *)
                ./src/lua test/${t}.lua || die "Test ./src/lua test/${t}.lua failed" ;;
        esac
    done
}

src_install() {
    default

    insinto /usr/$(get_libdir)/pkgconfig
    doins etc/${PN}.pc

    insinto /usr/share/pixmaps
    doins etc/${PN}.ico

    insinto /usr/share/doc/${PF}/html
    doins doc/*{css,html,gif,png}

    doman doc/*.?
}


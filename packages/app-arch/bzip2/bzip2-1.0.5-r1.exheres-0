# Copyright 2007 Bryan Ã˜stergaard
# Copyright 2008, 2009 Ingmar Vanhassel
# Distributed under the terms of the GNU General Public License v2

require multilib

SUMMARY="Freely available, patent free, high-quality data compressor"
HOMEPAGE="http://www.bzip.org"
DOWNLOADS="http://www.bzip.org/${PV}/${PNV}.tar.gz"

LICENCES="BSD-3"
SLOT="0"
PLATFORMS="~amd64 ~arm ~ia64 ~ppc64 ~x86"
MYOPTIONS=""

DEPENDENCIES=""

DEFAULT_SRC_INSTALL_PARAMS=( PREFIX="${IMAGE}" LIBDIR=$(get_libdir) MANPREFIX="${IMAGE}"/usr/share )
DEFAULT_SRC_INSTALL_EXTRA_DOCS=( bzip2.txt )

src_prepare() {
    default

    edo sed -e '/^CFLAGS/s/=/+=/' \
            -e '/^CFLAGS/s/-O.//' \
            -e '/^CFLAGS/s/-g//' \
            -i Makefile Makefile-libbz2_so

    edo sed -e "s:1\.0\.4:${PV}:" \
            -i bzip2.1 bzip2.txt Makefile-libbz2_so manual.{html,ps,xml}

    edo sed -e 's:$(PREFIX)/lib:$(PREFIX)/$(LIBDIR):g' \
            -e 's:$(PREFIX)/include:$(PREFIX)/usr/include:g' \
            -e 's:$(PREFIX)/man:$(PREFIX)/usr/share/man:g' \
            -i Makefile
}

src_compile() {
    local myemake=(
        CC="${CC}"
        AR="${AR}"
        RANLIB="${RANLIB}"
    )

    emake "${myemake[@]}" -f Makefile-libbz2_so
    emake "${myemake[@]}"
}


src_install() {
    default

    # Install shared libraries to /$(get_libdir)
    into /
    dolib.so libbz2.so.${PV}
    for v in libbz2.so{,.{$(ever major 1),$(ever range 1-2)}} ; do
        dosym libbz2.so.${PV} /$(get_libdir)/${v}
    done

    # Fix symlinks linking to ${IMAGE}
    dosym bzgrep /bin/bzegrep
    dosym bzgrep /bin/bzfgrep
    dosym bzmore /bin/bzless
    dosym bzdiff /bin/bzcmp
}

